/*! Meemoo Iframework http://meemoo.org/ - v0.3.4 - 2013-05-05 (1:54:07 PM GMT+0300)
* Copyright (c) 2013 Forrest Oliphant; Licensed MIT, AGPL */
(function(){var e=this,t=e._,i={},n=Array.prototype,o=Object.prototype,r=Function.prototype,s=n.push,a=n.slice,l=n.concat,h=o.toString,d=o.hasOwnProperty,u=n.forEach,c=n.map,p=n.reduce,g=n.reduceRight,f=n.filter,m=n.every,v=n.some,w=n.indexOf,y=n.lastIndexOf,b=Array.isArray,k=Object.keys,I=r.bind,$=function(e){return e instanceof $?e:this instanceof $?(this._wrapped=e,void 0):new $(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=$),exports._=$):e._=$,$.VERSION="1.4.4";var x=$.each=$.forEach=function(e,t,n){if(null!=e)if(u&&e.forEach===u)e.forEach(t,n);else if(e.length===+e.length){for(var o=0,r=e.length;r>o;o++)if(t.call(n,e[o],o,e)===i)return}else for(var s in e)if($.has(e,s)&&t.call(n,e[s],s,e)===i)return};$.map=$.collect=function(e,t,i){var n=[];return null==e?n:c&&e.map===c?e.map(t,i):(x(e,function(e,o,r){n[n.length]=t.call(i,e,o,r)}),n)};var _="Reduce of empty array with no initial value";$.reduce=$.foldl=$.inject=function(e,t,i,n){var o=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return n&&(t=$.bind(t,n)),o?e.reduce(t,i):e.reduce(t);if(x(e,function(e,r,s){o?i=t.call(n,i,e,r,s):(i=e,o=!0)}),!o)throw new TypeError(_);return i},$.reduceRight=$.foldr=function(e,t,i,n){var o=arguments.length>2;if(null==e&&(e=[]),g&&e.reduceRight===g)return n&&(t=$.bind(t,n)),o?e.reduceRight(t,i):e.reduceRight(t);var r=e.length;if(r!==+r){var s=$.keys(e);r=s.length}if(x(e,function(a,l,h){l=s?s[--r]:--r,o?i=t.call(n,i,e[l],l,h):(i=e[l],o=!0)}),!o)throw new TypeError(_);return i},$.find=$.detect=function(e,t,i){var n;return E(e,function(e,o,r){return t.call(i,e,o,r)?(n=e,!0):void 0}),n},$.filter=$.select=function(e,t,i){var n=[];return null==e?n:f&&e.filter===f?e.filter(t,i):(x(e,function(e,o,r){t.call(i,e,o,r)&&(n[n.length]=e)}),n)},$.reject=function(e,t,i){return $.filter(e,function(e,n,o){return!t.call(i,e,n,o)},i)},$.every=$.all=function(e,t,n){t||(t=$.identity);var o=!0;return null==e?o:m&&e.every===m?e.every(t,n):(x(e,function(e,r,s){return(o=o&&t.call(n,e,r,s))?void 0:i}),!!o)};var E=$.some=$.any=function(e,t,n){t||(t=$.identity);var o=!1;return null==e?o:v&&e.some===v?e.some(t,n):(x(e,function(e,r,s){return o||(o=t.call(n,e,r,s))?i:void 0}),!!o)};$.contains=$.include=function(e,t){return null==e?!1:w&&e.indexOf===w?-1!=e.indexOf(t):E(e,function(e){return e===t})},$.invoke=function(e,t){var i=a.call(arguments,2),n=$.isFunction(t);return $.map(e,function(e){return(n?t:e[t]).apply(e,i)})},$.pluck=function(e,t){return $.map(e,function(e){return e[t]})},$.where=function(e,t,i){return $.isEmpty(t)?i?null:[]:$[i?"find":"filter"](e,function(e){for(var i in t)if(t[i]!==e[i])return!1;return!0})},$.findWhere=function(e,t){return $.where(e,t,!0)},$.max=function(e,t,i){if(!t&&$.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.max.apply(Math,e);if(!t&&$.isEmpty(e))return-1/0;var n={computed:-1/0,value:-1/0};return x(e,function(e,o,r){var s=t?t.call(i,e,o,r):e;s>=n.computed&&(n={value:e,computed:s})}),n.value},$.min=function(e,t,i){if(!t&&$.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.min.apply(Math,e);if(!t&&$.isEmpty(e))return 1/0;var n={computed:1/0,value:1/0};return x(e,function(e,o,r){var s=t?t.call(i,e,o,r):e;n.computed>s&&(n={value:e,computed:s})}),n.value},$.shuffle=function(e){var t,i=0,n=[];return x(e,function(e){t=$.random(i++),n[i-1]=n[t],n[t]=e}),n};var S=function(e){return $.isFunction(e)?e:function(t){return t[e]}};$.sortBy=function(e,t,i){var n=S(t);return $.pluck($.map(e,function(e,t,o){return{value:e,index:t,criteria:n.call(i,e,t,o)}}).sort(function(e,t){var i=e.criteria,n=t.criteria;if(i!==n){if(i>n||void 0===i)return 1;if(n>i||void 0===n)return-1}return e.index<t.index?-1:1}),"value")};var N=function(e,t,i,n){var o={},r=S(t||$.identity);return x(e,function(t,s){var a=r.call(i,t,s,e);n(o,a,t)}),o};$.groupBy=function(e,t,i){return N(e,t,i,function(e,t,i){($.has(e,t)?e[t]:e[t]=[]).push(i)})},$.countBy=function(e,t,i){return N(e,t,i,function(e,t){$.has(e,t)||(e[t]=0),e[t]++})},$.sortedIndex=function(e,t,i,n){i=null==i?$.identity:S(i);for(var o=i.call(n,t),r=0,s=e.length;s>r;){var a=r+s>>>1;o>i.call(n,e[a])?r=a+1:s=a}return r},$.toArray=function(e){return e?$.isArray(e)?a.call(e):e.length===+e.length?$.map(e,$.identity):$.values(e):[]},$.size=function(e){return null==e?0:e.length===+e.length?e.length:$.keys(e).length},$.first=$.head=$.take=function(e,t,i){return null==e?void 0:null==t||i?e[0]:a.call(e,0,t)},$.initial=function(e,t,i){return a.call(e,0,e.length-(null==t||i?1:t))},$.last=function(e,t,i){return null==e?void 0:null==t||i?e[e.length-1]:a.call(e,Math.max(e.length-t,0))},$.rest=$.tail=$.drop=function(e,t,i){return a.call(e,null==t||i?1:t)},$.compact=function(e){return $.filter(e,$.identity)};var C=function(e,t,i){return x(e,function(e){$.isArray(e)?t?s.apply(i,e):C(e,t,i):i.push(e)}),i};$.flatten=function(e,t){return C(e,t,[])},$.without=function(e){return $.difference(e,a.call(arguments,1))},$.uniq=$.unique=function(e,t,i,n){$.isFunction(t)&&(n=i,i=t,t=!1);var o=i?$.map(e,i,n):e,r=[],s=[];return x(o,function(i,n){(t?n&&s[s.length-1]===i:$.contains(s,i))||(s.push(i),r.push(e[n]))}),r},$.union=function(){return $.uniq(l.apply(n,arguments))},$.intersection=function(e){var t=a.call(arguments,1);return $.filter($.uniq(e),function(e){return $.every(t,function(t){return $.indexOf(t,e)>=0})})},$.difference=function(e){var t=l.apply(n,a.call(arguments,1));return $.filter(e,function(e){return!$.contains(t,e)})},$.zip=function(){for(var e=a.call(arguments),t=$.max($.pluck(e,"length")),i=Array(t),n=0;t>n;n++)i[n]=$.pluck(e,""+n);return i},$.object=function(e,t){if(null==e)return{};for(var i={},n=0,o=e.length;o>n;n++)t?i[e[n]]=t[n]:i[e[n][0]]=e[n][1];return i},$.indexOf=function(e,t,i){if(null==e)return-1;var n=0,o=e.length;if(i){if("number"!=typeof i)return n=$.sortedIndex(e,t),e[n]===t?n:-1;n=0>i?Math.max(0,o+i):i}if(w&&e.indexOf===w)return e.indexOf(t,i);for(;o>n;n++)if(e[n]===t)return n;return-1},$.lastIndexOf=function(e,t,i){if(null==e)return-1;var n=null!=i;if(y&&e.lastIndexOf===y)return n?e.lastIndexOf(t,i):e.lastIndexOf(t);for(var o=n?i:e.length;o--;)if(e[o]===t)return o;return-1},$.range=function(e,t,i){1>=arguments.length&&(t=e||0,e=0),i=arguments[2]||1;for(var n=Math.max(Math.ceil((t-e)/i),0),o=0,r=Array(n);n>o;)r[o++]=e,e+=i;return r},$.bind=function(e,t){if(e.bind===I&&I)return I.apply(e,a.call(arguments,1));var i=a.call(arguments,2);return function(){return e.apply(t,i.concat(a.call(arguments)))}},$.partial=function(e){var t=a.call(arguments,1);return function(){return e.apply(this,t.concat(a.call(arguments)))}},$.bindAll=function(e){var t=a.call(arguments,1);return 0===t.length&&(t=$.functions(e)),x(t,function(t){e[t]=$.bind(e[t],e)}),e},$.memoize=function(e,t){var i={};return t||(t=$.identity),function(){var n=t.apply(this,arguments);return $.has(i,n)?i[n]:i[n]=e.apply(this,arguments)}},$.delay=function(e,t){var i=a.call(arguments,2);return setTimeout(function(){return e.apply(null,i)},t)},$.defer=function(e){return $.delay.apply($,[e,1].concat(a.call(arguments,1)))},$.throttle=function(e,t){var i,n,o,r,s=0,a=function(){s=new Date,o=null,r=e.apply(i,n)};return function(){var l=new Date,h=t-(l-s);return i=this,n=arguments,0>=h?(clearTimeout(o),o=null,s=l,r=e.apply(i,n)):o||(o=setTimeout(a,h)),r}},$.debounce=function(e,t,i){var n,o;return function(){var r=this,s=arguments,a=function(){n=null,i||(o=e.apply(r,s))},l=i&&!n;return clearTimeout(n),n=setTimeout(a,t),l&&(o=e.apply(r,s)),o}},$.once=function(e){var t,i=!1;return function(){return i?t:(i=!0,t=e.apply(this,arguments),e=null,t)}},$.wrap=function(e,t){return function(){var i=[e];return s.apply(i,arguments),t.apply(this,i)}},$.compose=function(){var e=arguments;return function(){for(var t=arguments,i=e.length-1;i>=0;i--)t=[e[i].apply(this,t)];return t[0]}},$.after=function(e,t){return 0>=e?t():function(){return 1>--e?t.apply(this,arguments):void 0}},$.keys=k||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var i in e)$.has(e,i)&&(t[t.length]=i);return t},$.values=function(e){var t=[];for(var i in e)$.has(e,i)&&t.push(e[i]);return t},$.pairs=function(e){var t=[];for(var i in e)$.has(e,i)&&t.push([i,e[i]]);return t},$.invert=function(e){var t={};for(var i in e)$.has(e,i)&&(t[e[i]]=i);return t},$.functions=$.methods=function(e){var t=[];for(var i in e)$.isFunction(e[i])&&t.push(i);return t.sort()},$.extend=function(e){return x(a.call(arguments,1),function(t){if(t)for(var i in t)e[i]=t[i]}),e},$.pick=function(e){var t={},i=l.apply(n,a.call(arguments,1));return x(i,function(i){i in e&&(t[i]=e[i])}),t},$.omit=function(e){var t={},i=l.apply(n,a.call(arguments,1));for(var o in e)$.contains(i,o)||(t[o]=e[o]);return t},$.defaults=function(e){return x(a.call(arguments,1),function(t){if(t)for(var i in t)null==e[i]&&(e[i]=t[i])}),e},$.clone=function(e){return $.isObject(e)?$.isArray(e)?e.slice():$.extend({},e):e},$.tap=function(e,t){return t(e),e};var P=function(e,t,i,n){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof $&&(e=e._wrapped),t instanceof $&&(t=t._wrapped);var o=h.call(e);if(o!=h.call(t))return!1;switch(o){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var r=i.length;r--;)if(i[r]==e)return n[r]==t;i.push(e),n.push(t);var s=0,a=!0;if("[object Array]"==o){if(s=e.length,a=s==t.length)for(;s--&&(a=P(e[s],t[s],i,n)););}else{var l=e.constructor,d=t.constructor;if(l!==d&&!($.isFunction(l)&&l instanceof l&&$.isFunction(d)&&d instanceof d))return!1;for(var u in e)if($.has(e,u)&&(s++,!(a=$.has(t,u)&&P(e[u],t[u],i,n))))break;if(a){for(u in t)if($.has(t,u)&&!s--)break;a=!s}}return i.pop(),n.pop(),a};$.isEqual=function(e,t){return P(e,t,[],[])},$.isEmpty=function(e){if(null==e)return!0;if($.isArray(e)||$.isString(e))return 0===e.length;for(var t in e)if($.has(e,t))return!1;return!0},$.isElement=function(e){return!(!e||1!==e.nodeType)},$.isArray=b||function(e){return"[object Array]"==h.call(e)},$.isObject=function(e){return e===Object(e)},x(["Arguments","Function","String","Number","Date","RegExp"],function(e){$["is"+e]=function(t){return h.call(t)=="[object "+e+"]"}}),$.isArguments(arguments)||($.isArguments=function(e){return!(!e||!$.has(e,"callee"))}),true&&($.isFunction=function(e){return"function"==typeof e}),$.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},$.isNaN=function(e){return $.isNumber(e)&&e!=+e},$.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==h.call(e)},$.isNull=function(e){return null===e},$.isUndefined=function(e){return void 0===e},$.has=function(e,t){return d.call(e,t)},$.noConflict=function(){return e._=t,this},$.identity=function(e){return e},$.times=function(e,t,i){for(var n=Array(e),o=0;e>o;o++)n[o]=t.call(i,o);return n},$.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var T={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};T.unescape=$.invert(T.escape);var O={escape:RegExp("["+$.keys(T.escape).join("")+"]","g"),unescape:RegExp("("+$.keys(T.unescape).join("|")+")","g")};$.each(["escape","unescape"],function(e){$[e]=function(t){return null==t?"":(""+t).replace(O[e],function(t){return T[e][t]})}}),$.result=function(e,t){if(null==e)return null;var i=e[t];return $.isFunction(i)?i.call(e):i},$.mixin=function(e){x($.functions(e),function(t){var i=$[t]=e[t];$.prototype[t]=function(){var e=[this._wrapped];return s.apply(e,arguments),M.call(this,i.apply($,e))}})};var G=0;$.uniqueId=function(e){var t=++G+"";return e?e+t:t},$.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var L=/(.)^/,A={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},z=/\\|'|\r|\n|\t|\u2028|\u2029/g;$.template=function(e,t,i){var n;i=$.defaults({},i,$.templateSettings);var o=RegExp([(i.escape||L).source,(i.interpolate||L).source,(i.evaluate||L).source].join("|")+"|$","g"),r=0,s="__p+='";e.replace(o,function(t,i,n,o,a){return s+=e.slice(r,a).replace(z,function(e){return"\\"+A[e]}),i&&(s+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'"),n&&(s+="'+\n((__t=("+n+"))==null?'':__t)+\n'"),o&&(s+="';\n"+o+"\n__p+='"),r=a+t.length,t}),s+="';\n",i.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{n=Function(i.variable||"obj","_",s)}catch(a){throw a.source=s,a}if(t)return n(t,$);var l=function(e){return n.call(this,e,$)};return l.source="function("+(i.variable||"obj")+"){\n"+s+"}",l},$.chain=function(e){return $(e).chain()};var M=function(e){return this._chain?$(e).chain():e};$.mixin($),x(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=n[e];$.prototype[e]=function(){var i=this._wrapped;return t.apply(i,arguments),"shift"!=e&&"splice"!=e||0!==i.length||delete i[0],M.call(this,i)}}),x(["concat","join","slice"],function(e){var t=n[e];$.prototype[e]=function(){return M.call(this,t.apply(this._wrapped,arguments))}}),$.extend($.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),function(){var e,t=this,i=t.Backbone,n=[],o=n.push,r=n.slice,s=n.splice;e="undefined"!=typeof exports?exports:t.Backbone={},e.VERSION="1.0.0";var a=t._;a||"undefined"==typeof require||(a=require("underscore")),e.$=t.jQuery||t.Zepto||t.ender||t.$,e.noConflict=function(){return t.Backbone=i,this},e.emulateHTTP=!1,e.emulateJSON=!1;var l=e.Events={on:function(e,t,i){if(!d(this,"on",e,[t,i])||!t)return this;this._events||(this._events={});var n=this._events[e]||(this._events[e]=[]);return n.push({callback:t,context:i,ctx:i||this}),this},once:function(e,t,i){if(!d(this,"once",e,[t,i])||!t)return this;var n=this,o=a.once(function(){n.off(e,o),t.apply(this,arguments)});return o._callback=t,this.on(e,o,i)},off:function(e,t,i){var n,o,r,s,l,h,u,c;if(!this._events||!d(this,"off",e,[t,i]))return this;if(!e&&!t&&!i)return this._events={},this;for(s=e?[e]:a.keys(this._events),l=0,h=s.length;h>l;l++)if(e=s[l],r=this._events[e]){if(this._events[e]=n=[],t||i)for(u=0,c=r.length;c>u;u++)o=r[u],(t&&t!==o.callback&&t!==o.callback._callback||i&&i!==o.context)&&n.push(o);n.length||delete this._events[e]}return this},trigger:function(e){if(!this._events)return this;var t=r.call(arguments,1);if(!d(this,"trigger",e,t))return this;var i=this._events[e],n=this._events.all;return i&&u(i,t),n&&u(n,arguments),this},stopListening:function(e,t,i){var n=this._listeners;if(!n)return this;var o=!t&&!i;"object"==typeof t&&(i=this),e&&((n={})[e._listenerId]=e);for(var r in n)n[r].off(t,i,this),o&&delete this._listeners[r];return this}},h=/\s+/,d=function(e,t,i,n){if(!i)return!0;if("object"==typeof i){for(var o in i)e[t].apply(e,[o,i[o]].concat(n));return!1}if(h.test(i)){for(var r=i.split(h),s=0,a=r.length;a>s;s++)e[t].apply(e,[r[s]].concat(n));return!1}return!0},u=function(e,t){var i,n=-1,o=e.length,r=t[0],s=t[1],a=t[2];switch(t.length){case 0:for(;o>++n;)(i=e[n]).callback.call(i.ctx);return;case 1:for(;o>++n;)(i=e[n]).callback.call(i.ctx,r);return;case 2:for(;o>++n;)(i=e[n]).callback.call(i.ctx,r,s);return;case 3:for(;o>++n;)(i=e[n]).callback.call(i.ctx,r,s,a);return;default:for(;o>++n;)(i=e[n]).callback.apply(i.ctx,t)}},c={listenTo:"on",listenToOnce:"once"};a.each(c,function(e,t){l[t]=function(t,i,n){var o=this._listeners||(this._listeners={}),r=t._listenerId||(t._listenerId=a.uniqueId("l"));return o[r]=t,"object"==typeof i&&(n=this),t[e](i,n,this),this}}),l.bind=l.on,l.unbind=l.off,a.extend(e,l);var p=e.Model=function(e,t){var i,n=e||{};t||(t={}),this.cid=a.uniqueId("c"),this.attributes={},a.extend(this,a.pick(t,g)),t.parse&&(n=this.parse(n,t)||{}),(i=a.result(this,"defaults"))&&(n=a.defaults({},n,i)),this.set(n,t),this.changed={},this.initialize.apply(this,arguments)},g=["url","urlRoot","collection"];a.extend(p.prototype,l,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return a.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return a.escape(this.get(e))},has:function(e){return null!=this.get(e)},set:function(e,t,i){var n,o,r,s,l,h,d,u;if(null==e)return this;if("object"==typeof e?(o=e,i=t):(o={})[e]=t,i||(i={}),!this._validate(o,i))return!1;r=i.unset,l=i.silent,s=[],h=this._changing,this._changing=!0,h||(this._previousAttributes=a.clone(this.attributes),this.changed={}),u=this.attributes,d=this._previousAttributes,this.idAttribute in o&&(this.id=o[this.idAttribute]);for(n in o)t=o[n],a.isEqual(u[n],t)||s.push(n),a.isEqual(d[n],t)?delete this.changed[n]:this.changed[n]=t,r?delete u[n]:u[n]=t;if(!l){s.length&&(this._pending=!0);for(var c=0,p=s.length;p>c;c++)this.trigger("change:"+s[c],this,u[s[c]],i)}if(h)return this;if(!l)for(;this._pending;)this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,a.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var i in this.attributes)t[i]=void 0;return this.set(t,a.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!a.isEmpty(this.changed):a.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?a.clone(this.changed):!1;var t,i=!1,n=this._changing?this._previousAttributes:this.attributes;for(var o in e)a.isEqual(n[o],t=e[o])||((i||(i={}))[o]=t);return i},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return a.clone(this._previousAttributes)},fetch:function(e){e=e?a.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=this,i=e.success;return e.success=function(n){return t.set(t.parse(n,e),e)?(i&&i(t,n,e),t.trigger("sync",t,n,e),void 0):!1},M(this,e),this.sync("read",this,e)},save:function(e,t,i){var n,o,r,s=this.attributes;if(null==e||"object"==typeof e?(n=e,i=t):(n={})[e]=t,!(!n||i&&i.wait||this.set(n,i)))return!1;if(i=a.extend({validate:!0},i),!this._validate(n,i))return!1;n&&i.wait&&(this.attributes=a.extend({},s,n)),void 0===i.parse&&(i.parse=!0);var l=this,h=i.success;return i.success=function(e){l.attributes=s;var t=l.parse(e,i);return i.wait&&(t=a.extend(n||{},t)),a.isObject(t)&&!l.set(t,i)?!1:(h&&h(l,e,i),l.trigger("sync",l,e,i),void 0)},M(this,i),o=this.isNew()?"create":i.patch?"patch":"update","patch"===o&&(i.attrs=n),r=this.sync(o,this,i),n&&i.wait&&(this.attributes=s),r},destroy:function(e){e=e?a.clone(e):{};var t=this,i=e.success,n=function(){t.trigger("destroy",t,t.collection,e)};if(e.success=function(o){(e.wait||t.isNew())&&n(),i&&i(t,o,e),t.isNew()||t.trigger("sync",t,o,e)},this.isNew())return e.success(),!1;M(this,e);var o=this.sync("delete",this,e);return e.wait||n(),o},url:function(){var e=a.result(this,"urlRoot")||a.result(this.collection,"url")||z();return this.isNew()?e:e+("/"===e.charAt(e.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(e){return this._validate({},a.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=a.extend({},this.attributes,e);var i=this.validationError=this.validate(e,t)||null;return i?(this.trigger("invalid",this,i,a.extend(t||{},{validationError:i})),!1):!0}});var f=["keys","values","pairs","invert","pick","omit"];a.each(f,function(e){p.prototype[e]=function(){var t=r.call(arguments);return t.unshift(this.attributes),a[e].apply(a,t)}});var m=e.Collection=function(e,t){t||(t={}),t.url&&(this.url=t.url),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,a.extend({silent:!0},t))},v={add:!0,remove:!0,merge:!0},w={add:!0,merge:!1,remove:!1};a.extend(m.prototype,l,{model:p,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return e.sync.apply(this,arguments)},add:function(e,t){return this.set(e,a.defaults(t||{},w))},remove:function(e,t){e=a.isArray(e)?e.slice():[e],t||(t={});var i,n,o,r;for(i=0,n=e.length;n>i;i++)r=this.get(e[i]),r&&(delete this._byId[r.id],delete this._byId[r.cid],o=this.indexOf(r),this.models.splice(o,1),this.length--,t.silent||(t.index=o,r.trigger("remove",r,this,t)),this._removeReference(r));return this},set:function(e,t){t=a.defaults(t||{},v),t.parse&&(e=this.parse(e,t)),a.isArray(e)||(e=e?[e]:[]);var i,n,r,l,h,d=t.at,u=this.comparator&&null==d&&t.sort!==!1,c=a.isString(this.comparator)?this.comparator:null,p=[],g=[],f={};for(i=0,n=e.length;n>i;i++)(r=this._prepareModel(e[i],t))&&((l=this.get(r))?(t.remove&&(f[l.cid]=!0),t.merge&&(l.set(r.attributes,t),u&&!h&&l.hasChanged(c)&&(h=!0))):t.add&&(p.push(r),r.on("all",this._onModelEvent,this),this._byId[r.cid]=r,null!=r.id&&(this._byId[r.id]=r)));if(t.remove){for(i=0,n=this.length;n>i;++i)f[(r=this.models[i]).cid]||g.push(r);g.length&&this.remove(g,t)}if(p.length&&(u&&(h=!0),this.length+=p.length,null!=d?s.apply(this.models,[d,0].concat(p)):o.apply(this.models,p)),h&&this.sort({silent:!0}),t.silent)return this;for(i=0,n=p.length;n>i;i++)(r=p[i]).trigger("add",r,this,t);return h&&this.trigger("sort",this,t),this},reset:function(e,t){t||(t={});for(var i=0,n=this.models.length;n>i;i++)this._removeReference(this.models[i]);return t.previousModels=this.models,this._reset(),this.add(e,a.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,a.extend({at:this.length},t)),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,a.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return null==e?void 0:this._byId[null!=e.id?e.id:e.cid||e]},at:function(e){return this.models[e]},where:function(e,t){return a.isEmpty(e)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var i in e)if(e[i]!==t.get(i))return!1;return!0})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw Error("Cannot sort a set without a comparator");return e||(e={}),a.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(a.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},sortedIndex:function(e,t,i){t||(t=this.comparator);var n=a.isFunction(t)?t:function(e){return e.get(t)};return a.sortedIndex(this.models,e,n,i)},pluck:function(e){return a.invoke(this.models,"get",e)},fetch:function(e){e=e?a.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=e.success,i=this;return e.success=function(n){var o=e.reset?"reset":"set";i[o](n,e),t&&t(i,n,e),i.trigger("sync",i,n,e)},M(this,e),this.sync("read",this,e)},create:function(e,t){if(t=t?a.clone(t):{},!(e=this._prepareModel(e,t)))return!1;t.wait||this.add(e,t);var i=this,n=t.success;return t.success=function(o){t.wait&&i.add(e,t),n&&n(e,o,t)},e.save(null,t),e},parse:function(e){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(e instanceof p)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var i=new this.model(e,t);return i._validate(e,t)?i:(this.trigger("invalid",this,e,t),!1)},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,i,n){("add"!==e&&"remove"!==e||i===this)&&("destroy"===e&&this.remove(t,n),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],null!=t.id&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments))}});var y=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];a.each(y,function(e){m.prototype[e]=function(){var t=r.call(arguments);return t.unshift(this.models),a[e].apply(a,t)}});var b=["groupBy","countBy","sortBy"];a.each(b,function(e){m.prototype[e]=function(t,i){var n=a.isFunction(t)?t:function(e){return e.get(t)};return a[e](this.models,n,i)}});var k=e.View=function(e){this.cid=a.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},I=/^(\S+)\s*(.*)$/,$=["model","collection","el","id","attributes","className","tagName","events"];a.extend(k.prototype,l,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t,i){return this.$el&&this.undelegateEvents(),this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0],i!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=a.result(this,"events")))return this;this.undelegateEvents();for(var t in e){var i=e[t];if(a.isFunction(i)||(i=this[e[t]]),i){var n=t.match(I),o=n[1],r=n[2];i=a.bind(i,this),o+=".delegateEvents"+this.cid,""===r?this.$el.on(o,i):this.$el.on(o,r,i)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(e){this.options&&(e=a.extend({},a.result(this,"options"),e)),a.extend(this,a.pick(e,$)),this.options=e},_ensureElement:function(){if(this.el)this.setElement(a.result(this,"el"),!1);else{var t=a.extend({},a.result(this,"attributes"));this.id&&(t.id=a.result(this,"id")),this.className&&(t["class"]=a.result(this,"className"));var i=e.$("<"+a.result(this,"tagName")+">").attr(t);this.setElement(i,!1)}}}),e.sync=function(t,i,n){var o=x[t];a.defaults(n||(n={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var r={type:o,dataType:"json"};if(n.url||(r.url=a.result(i,"url")||z()),null!=n.data||!i||"create"!==t&&"update"!==t&&"patch"!==t||(r.contentType="application/json",r.data=JSON.stringify(n.attrs||i.toJSON(n))),n.emulateJSON&&(r.contentType="application/x-www-form-urlencoded",r.data=r.data?{model:r.data}:{}),n.emulateHTTP&&("PUT"===o||"DELETE"===o||"PATCH"===o)){r.type="POST",n.emulateJSON&&(r.data._method=o);var s=n.beforeSend;n.beforeSend=function(e){return e.setRequestHeader("X-HTTP-Method-Override",o),s?s.apply(this,arguments):void 0}}"GET"===r.type||n.emulateJSON||(r.processData=!1),"PATCH"!==r.type||!window.ActiveXObject||window.external&&window.external.msActiveXFilteringEnabled||(r.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var l=n.xhr=e.ajax(a.extend(r,n));return i.trigger("request",i,l,n),l};var x={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var _=e.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},E=/\((.*?)\)/g,S=/(\(\?)?:\w+/g,N=/\*\w+/g,C=/[\-{}\[\]+?.,\\\^$|#\s]/g;a.extend(_.prototype,l,{initialize:function(){},route:function(t,i,n){a.isRegExp(t)||(t=this._routeToRegExp(t)),a.isFunction(i)&&(n=i,i=""),n||(n=this[i]);var o=this;return e.history.route(t,function(r){var s=o._extractParameters(t,r);n&&n.apply(o,s),o.trigger.apply(o,["route:"+i].concat(s)),o.trigger("route",i,s),e.history.trigger("route",o,i,s)}),this},navigate:function(t,i){return e.history.navigate(t,i),this},_bindRoutes:function(){if(this.routes){this.routes=a.result(this,"routes");for(var e,t=a.keys(this.routes);null!=(e=t.pop());)this.route(e,this.routes[e])}},_routeToRegExp:function(e){return e=e.replace(C,"\\$&").replace(E,"(?:$1)?").replace(S,function(e,t){return t?e:"([^/]+)"}).replace(N,"(.*?)"),RegExp("^"+e+"$")},_extractParameters:function(e,t){var i=e.exec(t).slice(1);return a.map(i,function(e){return e?decodeURIComponent(e):null})}});var P=e.History=function(){this.handlers=[],a.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},T=/^[#\/]|\s+$/g,O=/^\/+|\/+$/g,G=/msie [\w.]+/,L=/\/$/;P.started=!1,a.extend(P.prototype,l,{interval:50,getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(e,t){if(null==e)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var i=this.root.replace(L,"");e.indexOf(i)||(e=e.substr(i.length))}else e=this.getHash();return e.replace(T,"")},start:function(t){if(P.started)throw Error("Backbone.history has already been started");P.started=!0,this.options=a.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var i=this.getFragment(),n=document.documentMode,o=G.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);this.root=("/"+this.root+"/").replace(O,"/"),o&&this._wantsHashChange&&(this.iframe=e.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(i)),this._hasPushState?e.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!o?e.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=i;var r=this.location,s=r.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&s&&r.hash&&(this.fragment=this.getHash().replace(T,""),this.history.replaceState({},document.title,this.root+this.fragment+r.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){e.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),P.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(){var e=this.getFragment();return e===this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e===this.fragment?!1:(this.iframe&&this.navigate(e),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(e){var t=this.fragment=this.getFragment(e),i=a.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0});return i},navigate:function(e,t){if(!P.started)return!1;if(t&&t!==!0||(t={trigger:t}),e=this.getFragment(e||""),this.fragment!==e){this.fragment=e;var i=this.root+e;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,i);else{if(!this._wantsHashChange)return this.location.assign(i);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)}},_updateHash:function(e,t,i){if(i){var n=e.href.replace(/(javascript:|#).*$/,"");e.replace(n+"#"+t)}else e.hash="#"+t}}),e.history=new P;var A=function(e,t){var i,n=this;i=e&&a.has(e,"constructor")?e.constructor:function(){return n.apply(this,arguments)},a.extend(i,n,t);var o=function(){this.constructor=i};return o.prototype=n.prototype,i.prototype=new o,e&&a.extend(i.prototype,e),i.__super__=n.prototype,i};p.extend=m.extend=_.extend=k.extend=P.extend=A;var z=function(){throw Error('A "url" property or function must be specified')
},M=function(e,t){var i=t.error;t.error=function(n){i&&i(e,n,t),e.trigger("error",e,n,t)}}}.call(this),function(){function e(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function t(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var i=this._,n=this.Backbone;n.LocalStorage=window.Store=function(e){this.name=e;var t=this.localStorage().getItem(this.name);this.records=t&&t.split(",")||[]},i.extend(n.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){return e.id||(e.id=t(),e.set(e.idAttribute,e.id)),this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),this.records.push(""+e.id),this.save(),e},update:function(e){return this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),i.include(this.records,""+e.id)||this.records.push(""+e.id),this.save(),e},find:function(e){return JSON.parse(this.localStorage().getItem(this.name+"-"+e.id))},findAll:function(){return i(this.records).chain().map(function(e){return JSON.parse(this.localStorage().getItem(this.name+"-"+e))},this).compact().value()},destroy:function(e){return this.localStorage().removeItem(this.name+"-"+e.id),this.records=i.reject(this.records,function(t){return t==""+e.id}),this.save(),e},localStorage:function(){return localStorage}}),n.LocalStorage.sync=window.Store.sync=n.localSync=function(e,t,i,n){var o=t.localStorage||t.collection.localStorage;"function"==typeof i&&(i={success:i,error:n});var r;switch(e){case"read":r=void 0!=t.id?o.find(t):o.findAll();break;case"create":r=o.create(t);break;case"update":r=o.update(t);break;case"delete":r=o.destroy(t)}r?i.success(r):i.error("Record not found")},n.ajaxSync=n.sync,n.getSyncMethod=function(e){return e.localStorage||e.collection&&e.collection.localStorage?n.localSync:n.ajaxSync},n.sync=function(e,t,i,o){return n.getSyncMethod(t).apply(this,[e,t,i,o])}}(),function(){function e(e,t,i){return e.addEventListener?e.addEventListener(t,i,!1):(e.attachEvent("on"+t,i),void 0)}function t(e){return"keypress"==e.type?String.fromCharCode(e.which):y[e.which]?y[e.which]:b[e.which]?b[e.which]:String.fromCharCode(e.which).toLowerCase()}function i(e){var t=e.target||e.srcElement,i=t.tagName;return(" "+t.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==i||"SELECT"==i||"TEXTAREA"==i||t.contentEditable&&"true"==t.contentEditable}function n(e,t){return e.sort().join(",")===t.sort().join(",")}function o(e){e=e||{};var t,i=!1;for(t in _)e[t]?i=!0:_[t]=0;i||(S=!1)}function r(e,t,i,o,r){var s,a,l=[],h=i.type;if(!$[e])return[];for("keyup"==h&&d(e)&&(t=[e]),s=0;$[e].length>s;++s)a=$[e][s],a.seq&&_[a.seq]!=a.level||h==a.action&&("keypress"==h&&!i.metaKey&&!i.ctrlKey||n(t,a.modifiers))&&(o&&a.combo==r&&$[e].splice(s,1),l.push(a));return l}function s(e){var t=[];return e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),t}function a(e,t){e(t)===!1&&(t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),t.returnValue=!1,t.cancelBubble=!0)}function l(e,t){if(!i(t)){var n,l=r(e,s(t),t),h={},u=!1;for(n=0;l.length>n;++n)l[n].seq?(u=!0,h[l[n].seq]=1,a(l[n].callback,t)):u||S||a(l[n].callback,t);t.type!=S||d(e)||o(h)}}function h(e){e.which="number"==typeof e.which?e.which:e.keyCode;var i=t(e);if(i)return"keyup"==e.type&&E==i?(E=!1,void 0):(l(i,e),void 0)}function d(e){return"shift"==e||"ctrl"==e||"alt"==e||"meta"==e}function u(){clearTimeout(w),w=setTimeout(o,1e3)}function c(){if(!v){v={};for(var e in y)e>95&&112>e||y.hasOwnProperty(e)&&(v[y[e]]=e)}return v}function p(e,t,i){return i||(i=c()[e]?"keydown":"keypress"),"keypress"==i&&t.length&&(i="keydown"),i}function g(e,i,n,r){_[e]=0,r||(r=p(i[0],[]));var s,l=function(){S=r,++_[e],u()},h=function(e){a(n,e),"keyup"!==r&&(E=t(e)),setTimeout(o,10)};for(s=0;i.length>s;++s)f(i[s],i.length-1>s?l:h,r,e,s)}function f(e,t,i,n,o){e=e.replace(/\s+/g," ");var s,a,l,h=e.split(" "),u=[];if(h.length>1)return g(e,h,t,i);for(l="+"===e?["+"]:e.split("+"),s=0;l.length>s;++s)a=l[s],I[a]&&(a=I[a]),i&&"keypress"!=i&&k[a]&&(a=k[a],u.push("shift")),d(a)&&u.push(a);i=p(a,u,i),$[a]||($[a]=[]),r(a,u,{type:i},!n,e),$[a][n?"unshift":"push"]({callback:t,modifiers:u,action:i,seq:n,level:o,combo:e})}function m(e,t,i){for(var n=0;e.length>n;++n)f(e[n],t,i)}for(var v,w,y={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},b={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},k={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},I={option:"alt",command:"meta","return":"enter",escape:"esc"},$={},x={},_={},E=!1,S=!1,N=1;20>N;++N)y[111+N]="f"+N;for(N=0;9>=N;++N)y[N+96]=N;e(document,"keypress",h),e(document,"keydown",h),e(document,"keyup",h);var C={bind:function(e,t,i){return m(e instanceof Array?e:[e],t,i),x[e+":"+i]=t,this},unbind:function(e,t){return x[e+":"+t]&&(delete x[e+":"+t],this.bind(e,function(){},t)),this},trigger:function(e,t){return x[e+":"+t](),this},reset:function(){return $={},x={},this}};window.Mousetrap=C,"function"==typeof define&&define.amd&&define("mousetrap",function(){return C})}(),$(function(){var e='<div class="showpanel"><button class="button show-load icon-folder-open">app</button></div><div class="panel"><div class="choosepanel"><button class="button show-load icon-folder-open">app</button><button class="button close icon-cancel" title="close menu"></button></div><div class="menu menu-load"><div class="controls"><form class="loadfromgist"><input class="loadfromgistinput" name="loadfromgistinput" placeholder="load app from gist url" type="text" /><button class="loadfromgistsubmit icon-ok" type="submit">load</button></form></div><div class="listing"><button class="button newblank icon-doc" title="new blank app">new</button><div class="currentapp"></div><div class="localapps"><h1>Saved Apps</h1></div><div class="examples"><h1>Examples</h1></div></div></div></div>',t='<h1>Current App</h1><div class="info"><h2 title="url, click to edit" class="seturl editable"></h2><p title="title, click to edit" class="settitle editable"></p><p title="description, click to edit" class="setdescription editable"></p></div><div class="savecontrols"><button class="savelocal icon-install">save local</button><button class="forklocal icon-split" title="save as... copy app and save under a new name">fork</button><button class="savegist icon-globe-1" title="save app to gist.github.com anonymously">save public</button><button class="deletelocal icon-trash" title="delete local app"></button></div><div class="permalink" title="last publicly saved version"></div>',i=Backbone.View.extend({tagName:"div",className:"app",template:_.template(e),currentTemplate:_.template(t),frameCount:0,NativeNodes:{},plugins:{},events:{"click .close":"closePanels","click .show-load":"showLoad","click .newblank":"newBlank","submit .loadfromgist":"loadFromGist","click .savegist":"saveGist","click .savelocal":"saveLocal","click .forklocal":"forkLocal","click .deletelocal":"deleteLocal","blur .settitle":"setTitle","blur .setdescription":"setDescription","blur .seturl":"setUrl"},initialize:function(){this.render(),$("body").prepend(this.el),this.closePanels(),this.once("allLoaded",this.loadLocalApps,this)},allLoaded:function(){this.trigger("allLoaded")},render:function(){return this.$el.html(this.template()),this},shownGraph:null,wireColors:["#FF9292","#00C2EE","#DCA761","#8BB0FF","#96BD6D","#E797D7","#29C6AD"],wireColorIndex:0,selectedPort:null,getWireColor:function(){var e=this.wireColors[this.wireColorIndex];return this.wireColorIndex++,this.wireColorIndex>this.wireColors.length-1&&(this.wireColorIndex=0),e},addMenu:function(e,t,i){var n=this,o=$('<div class="menu menu-'+e+'"></div>').append(t).hide();this.$(".panel").append(o);var r=$('<button class="button show-'+e+'">'+e+"</button>").click(function(){n.showPanel(e)});i&&r.addClass(i),this.$(".showpanel").append(r),this.$(".choosepanel > .close").before(r.clone(!0))},addMenuSection:function(e,t,i){var n=$("<h1>").text(e);this.$(".menu-"+i+" .listing").append(n,t)},loadGraph:function(e){return this.shownGraph&&(this.shownGraph.remove(),this.shownGraph=null),this.wireColorIndex=0,this.shownGraph=new Iframework.Graph(e),e.info.title&&(document.title="Meemoo: "+e.info.title),this.updateCurrentInfo(),this.shownGraph},gotMessage:function(e){if(Iframework.shownGraph){var t=Iframework.shownGraph.get("nodes").get(e.data.nodeid);if(t)for(var i in e.data)if(e.data.hasOwnProperty(i)){var n=e.data[i];switch(i){case"message":t.sendFromFrame(n);break;case"info":t.infoLoaded(n);break;case"addInput":t.addInput(n);break;case"addOutput":t.addOutput(n);break;case"stateReady":t.iframeLoaded();break;case"set":t.setValues(n);break;default:}}}},_exampleGraphs:[],_loadedExample:null,loadExampleApps:function(e){this._exampleGraphs=this._exampleGraphs.concat(e);for(var t="",i=0;e.length>i;i++){var n=e[i].info.url;n&&(t+='<a href="#example/'+n+'" title="'+e[i].info.title+": "+e[i].info.description+'">'+n+"</a> <br />")}this.$(".menu-load .examples").append(t),this.shownGraph||(this._loadedExample?this.loadExample(this._loadedExample):this._loadedLocal||this._loadedLocal||this._loadedGist||this.newBlank())},loadExample:function(e){this._loadedExample=e;for(var t=0;this._exampleGraphs.length>t;t++)if(this._exampleGraphs[t].info.url===e)return this._loadedLocalApp=null,this.loadGraph(this._exampleGraphs[t]),this.analyze("load","example",e),!0},closePanels:function(){this.$(".showpanel").show(),this.$(".panel").hide(),this.$(".graph").css("right","0px"),this.$(".menu").hide()},showPanel:function(e){if(this.$(".menu").hide(),this.$(".showpanel").hide(),this.$(".panel").show(),this.$(".graph").css("right","350px"),e)if(this.$(".menu-"+e).length>0)this.$(".menu-"+e).show(),this.trigger("showmenu:"+e);else{var t=this;_.delay(function(){t.$(".menu-"+e).show(),t.trigger("showmenu:"+e)},1e3)}},showLoad:function(){this.showPanel(),this.$(".menu-load").show()},loadFromGist:function(){var e=this.loadFromGistId(this.$(".loadfromgistinput").val());return e&&($(".loadfromgistinput").blur(),this.router&&this.router.navigate("gist/"+e),this.$(".loadfromgistinput").val("").attr("placeholder","loading..."),window.setTimeout(function(){this.$(".loadfromgistinput").attr("placeholder","load app from gist url")},1500)),!1},loadFromGistId:function(e){this._loadedGist=e;var t=e.split("/");return t.length>3&&"gist.github.com"===t[2]&&(e=t[t.length-1]),$.ajax({url:"https://api.github.com/gists/"+e,type:"GET",dataType:"jsonp"}).success(function(e){var t=[];for(var i in e.data.files)if(e.data.files.hasOwnProperty(i)){var n=JSON.parse(e.data.files[i].content);if(n){var o=e.data.html_url;n.info.parents&&n.info.parents.push||(n.info.parents=[]),-1===n.info.parents.indexOf(o)&&n.info.parents.push(o),t.push(n)}}t.length>0&&(Iframework.loadGraph(t[0]),Iframework.closePanels())}).error(function(e){console.warn("gist load error",e)}),this.analyze("load","gist",e),e},saveGist:function(){var e=this.shownGraph.toJSON(),t={description:"meemoo app: "+e.info.title,"public":!0};t.files={};var i=e.info.url+".json";t.files[i]={content:JSON.stringify(e,null,"  ")},this.$(".savegist").prop("disabled",!0).text("saving..."),$.ajax({url:"https://api.github.com/gists",type:"POST",dataType:"json",data:JSON.stringify(t)}).success(function(t){var i=Iframework.shownGraph.get("info");i.hasOwnProperty("parents")&&i.parents.push||(e.info.parents=[]),e.info.parents.push(t.html_url),Iframework.saveLocal(),Iframework.updateCurrentInfo(),Iframework.analyze("save","gist",t.id)}).error(function(e){var t="meemoo app: "+Iframework.shownGraph.toJSON().info.title;Iframework.$(".permalink").html('api is down (;_;) copy your app source code to <a href="https://gist.github.com/?description='+encodeURIComponent(t)+'" target="_blank">gist.github.com</a>'),console.warn("gist save error",e)}).complete(function(){this.$(".savegist").prop("disabled",!1).text("save public")})},loadLocalApps:function(){this._localApps=new Iframework.LocalApps,this._localApps.fetch({success:function(){Iframework._localApps.each(function(e){e.initializeView()}),Iframework.shownGraph||Iframework._loadedLocal&&Iframework.loadLocal(Iframework._loadedLocal)},error:function(){console.warn("error loading local apps")}})},_loadedLocal:null,_loadedLocalApp:null,loadLocal:function(e){if(this._loadedLocal=e,this._localApps){var t=this._localApps.getByUrl(e);return t?(t.load(),!0):(console.warn("Didn't find local app with matching url."),this.newBlank(),!1)}return!1},setKey:function(e){var t=window.prompt("Enter a url key",e);return t&&(t=this.encodeKey(t),this.shownGraph.setInfo("url",t)),t},encodeKey:function(e){return e=e.toLowerCase().replace(/ /g,"-"),e=encodeURIComponent(e)},saveLocal:function(){for(this.shownGraph.get("info")||this.shownGraph.set({info:{}});!this.shownGraph.get("info").hasOwnProperty("url")||""===this.shownGraph.get("info").url;){var e;if(e=this.shownGraph.get("info").hasOwnProperty("title")&&""!==this.shownGraph.get("info").title?this.shownGraph.get("info").title:"app-"+(new Date).getTime(),!this.setKey(e))return!1}var t,i=JSON.parse(JSON.stringify(this.shownGraph)),n=i.info.url;if(this._loadedLocalApp)if(this._localApps.getByUrl(n)&&this._localApps.getByUrl(n)!==this._loadedLocalApp){if(!window.confirm('"'+n+'" already exists as a local app. Do you want to replace it?'))return!1;t=this._localApps.updateOrCreate(i)}else t=this._loadedLocalApp,t.save({graph:i}),t.trigger("change");else{if(this._localApps.getByUrl(n)&&!window.confirm('"'+n+'" already exists as a local app. Do you want to replace it?'))return!1;t=this._localApps.updateOrCreate(i)}return this._loadedLocalApp=t,this.analyze("save","local","x"),this.updateCurrentInfo(),Iframework.router.navigate("local/"+n),t},forkLocal:function(){this._loadedLocalApp=null;var e=this.shownGraph.get("info").url+"-copy";this.setKey(e),this.saveLocal()},deleteLocal:function(){this._loadedLocalApp&&(this._loadedLocalApp.destroy(),this._loadedLocalApp=null)},setTitle:function(){var e=this.$(".currentapp .info .settitle").text();e!==this.shownGraph.get("info").title&&this.shownGraph.setInfo("title",e)},setDescription:function(){var e=this.$(".currentapp .info .setdescription").text();e!==this.shownGraph.get("info").description&&this.shownGraph.setInfo("description",e)},setUrl:function(){var e=this.$(".currentapp .info .seturl").text();e=this.encodeKey(e),e!==this.shownGraph.get("info").url&&this.shownGraph.setInfo("url",e)},updateCurrentInfo:function(){var e=this.shownGraph.toJSON();if(this.$(".currentapp").html(this.currentTemplate(e)),this.$(".currentapp .seturl").text(decodeURIComponent(e.info.url)),this.$(".currentapp .settitle").text(e.info.title),this.$(".currentapp .setdescription").text(e.info.description),this.$(".editable").attr("contenteditable","true"),e.info.hasOwnProperty("parents")){var t=e.info.parents;if(t.length>0){var i=t[t.length-1],n=i.split("/");if(n.length>0){var o=n[n.length-1],r="http://meemoo.org/iframework/#gist/"+o,s=encodeURIComponent(r),a=encodeURIComponent(e.info.title),l=$("<span />").text(r).click(function(e){var t;if(document.body.createTextRange)t=document.body.createTextRange(),t.moveToElementText(e.target),t.select();else if(window.getSelection){var i=window.getSelection();t=document.createRange(),t.selectNodeContents(e.target),i.removeAllRanges(),i.addRange(t)}}),h=$('<a title="your saved gist" target="_blank" class="share icon-github"></a>').attr("href",i),d=$('<a title="share on facebook" target="_blank" class="share icon-facebook-rect"></a>').attr("href","https://www.facebook.com/sharer.php?u="+s+"&t="+a),u=" "+e.info.title+" #meemoo "+e.info.description;u.length>=120&&(u=u.substr(0,115)+"..."),u=r+u;var c=$('<a title="post to twitter" target="_blank" class="share icon-twitter-bird"></a>').attr("href","https://twitter.com/intent/tweet?text="+encodeURIComponent(u));this.$(".currentapp .permalink").empty().append(l).append(" ").append(h).append(" ").append(d).append(c)}}}this._loadedLocalApp?this.$(".currentapp .deletelocal").show():this.$(".currentapp .deletelocal").hide()},newBlank:function(){this.loadGraph({info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]}),this._loadedLocalApp=null,this.showPanel("library"),Iframework.router.navigate("new")},analyze:function(){}});window.Iframework=new i,window.addEventListener("message",Iframework.gotMessage,!1)}),$(function(){Iframework.util={types:{undefined:"undefined",number:"number","boolean":"boolean",string:"string","[object Function]":"function","[object RegExp]":"regexp","[object Array]":"array","[object Date]":"date","[object Error]":"error","[object HTMLCanvasElement]":"HTMLCanvasElement","[object ImageData]":"ImageData"},type:function(e){return this.types[typeof e]||this.types[Object.prototype.toString.call(e)]||(e?"object":"null")},imageTypes:["png","gif","jpg","jpeg","webp"],isImageURL:function(e){var t=e.split(".");if(t.length>1){var i=t[t.length-1];return this.imageTypes.indexOf(i)>-1}return!1},imageDrop:function(e,t){e.stopPropagation();var i=e.data.self,n=t.helper.data("meemoo-drag-type");if(!n||"canvas"!==n)return!1;var o=e.data.inputName;if(!o)return!1;var r,s=t.helper.data("meemoo-image-url");if(s){var a=new Image;a.crossOrigin="anonymous",a.onload=function(){r=document.createElement("canvas");var e=r.getContext("2d");r.width=a.width,r.height=a.height,e.drawImage(a,0,0),i.receive(o,r)},a.src=s}else{if(r=t.helper.data("meemoo-drag-canvas"),!r)return!1;i.receive(o,r)}}},window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}()}),$(function(){Iframework.Event=Backbone.Model.extend({defaults:function(){return{action:"",args:{}}},initialize:function(){}}),Iframework.EventsHistory=Backbone.Collection.extend({model:Iframework.Event}),Mousetrap.bind(["command+z","ctrl+z"],function(){var e=window.Iframework.shownGraph,t=e.eventsHistory.last();if("removeNode"===t.get("action")){var i=t.get("args").node,n=e.usedIds.indexOf(i.get("id"));e.usedIds.splice(n,1),e.addNode(i);var o;for(o=0;i.Inputs.length>o;o++)i.view.addInput(i.Inputs.at(o));for(o=0;i.Outputs.length>o;o++)i.view.addOutput(i.Outputs.at(o));var r=t.get("args").edges;for(o=0;r.length>o;o++)e.addEdge(r[o])}e.eventsHistory.pop()})}),$(function(){Iframework.LocalApp=Backbone.Model.extend({initializeView:function(){return this.view||(this.view=new Iframework.LocalAppView({model:this})),this.view},load:function(){Iframework._loadedLocalApp=this;var e=JSON.parse(JSON.stringify(this.get("graph")));Iframework.loadGraph(e)},toJSON:function(){return{id:this.id,graph:this.get("graph")}}}),Iframework.LocalApps=Backbone.Collection.extend({model:Iframework.LocalApp,localStorage:new Backbone.LocalStorage("LocalApps"),getByUrl:function(e){var t=this.find(function(t){return t.get("graph").info.url===e});return t},updateOrCreate:function(e){var t;return t=this.find(function(t){return t.get("graph").info.url===e.info.url}),t?(t.save({graph:e}),t.trigger("change")):(t=this.create({graph:e}),t.initializeView()),t}})}),$(function(){var e='<a class="url" href="#local/<%= graph.info.url %>"></a><div class="info"><h2 class="title"><%= graph.info.title %></h2><p class="description"><%= graph.info.description %></p></div>';Iframework.LocalAppView=Backbone.View.extend({tagName:"div",className:"localapp",template:_.template(e),events:{},initialize:function(){return this.render(),Iframework.$(".localapps").append(this.el),this.model.on("change",this.update,this),this.model.on("destroy",this.remove,this),this},render:function(){this.$el.html(this.template(this.model.toJSON())),this.$(".url").text(decodeURIComponent(this.model.get("graph").info.url)),this.$(".info").hide()},update:function(){this.render(),Iframework.updateCurrentInfo()},remove:function(){this.$el.remove()}})}),$(function(){Iframework.Graph=Backbone.Model.extend({loaded:!1,defaults:{info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]},usedIds:[],edgeCount:0,eventsHistory:[],initialize:function(){if(this.usedIds=[],this.attributes.nodes){var e=this.attributes.nodes;this.attributes.nodes=new Iframework.Nodes;for(var t=0;e.length>t;t++){var i=this.makeNode(e[t]);i&&this.addNode(i)}}if(this.attributes.edges){var n=this.attributes.edges;this.attributes.edges=new Iframework.Edges;for(var o=0;n.length>o;o++){var r=new Iframework.Edge(n[o]);r.graph=this,this.addEdge(r)}}this.eventsHistory=new Iframework.EventsHistory,_.defer(function(){Iframework.shownGraph.testLoaded()}),this.on("change",this.graphChanged)},testLoaded:function(){var e=!0;return this.get("nodes").each(function(t){t.hasOwnProperty("lazyLoadType")&&(Iframework.NativeNodes.hasOwnProperty(t.lazyLoadType)?t.view&&!t.Native&&t.view.initializeNative():e=!1)},this),e&&this.initializeView(),e},initializeView:function(){this.view||(this.view=new Iframework.GraphView({model:this}))},setInfo:function(e,t){var i=this.get("info");i[e]=t,this.trigger("change")},makeNode:function(e){if(!e.src)return!1;e.parentGraph=this;var t;if(Iframework.util.isImageURL(e.src)){var i=e.src;e.src="meemoo:image/in",e.state||(e.state={}),e.state.url=i}var n=e.src.split(":");if(2>n.length)return!1;if("meemoo"===n[0]){var o=n[n.length-1],r=o.split("/");o=r.join("-"),r[0]&&r[1]&&yepnope([{test:Iframework.NativeNodes.hasOwnProperty(r[0]),nope:"src/nodes/"+r[0]+".js"},{test:Iframework.NativeNodes.hasOwnProperty(r[0]+"-"+r[1]),nope:"src/nodes/"+r[0]+"-"+r[1]+".js",complete:function(){_.defer(function(){Iframework.shownGraph.testLoaded()})}}]),t=new Iframework.NodeBox(e),t.lazyLoadType=o}else t=new Iframework.NodeBoxIframe(e);return t},addNode:function(e){if(!e.cid&&(e=this.makeNode(e),!e))return!1;e.graph=this;var t=this.get("nodes").length,i=parseInt(e.get("id"),10);for(i!==i&&e.set({id:t});this.usedIds.indexOf(e.get("id"))>=0;)t++,e.set({id:t});this.usedIds.push(e.get("id"));for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o="",r=0;5>r;r++)o+=n.charAt(Math.floor(Math.random()*n.length));return e.frameIndex="frame_"+e.get("id")+"_"+Iframework.frameCount++ +o+"_through",this.get("nodes").add(e),this.view&&this.view.addNode(e),this.trigger("change"),e},addEdge:function(e){var t=this.get("edges").any(function(t){return t.get("source")[0]===e.get("source")[0]&&t.get("source")[1]===e.get("source")[1]&&t.get("target")[0]===e.get("target")[0]&&t.get("target")[1]===e.get("target")[1]});return t?(console.warn("duplicate edge ignored",e),!1):(this.trigger("change"),this.get("edges").add(e))},remove:function(){this.get("nodes").each(function(e){e.remove(!1)}),this.view&&this.view.remove()},removeNode:function(e){var t=[];this.get("edges").each(function(i){(i.Source.parentNode===e||i.Target.parentNode===e)&&t.push(i)},this),_.each(t,function(e){e.remove()}),this.view&&this.view.removeNode(e),this.get("nodes").remove(e),this.eventsHistory.add(new Iframework.Event({action:"removeNode",args:{node:e,edges:t}})),this.trigger("change")},removeEdge:function(e){e.disconnect(),this.get("edges").remove(e),this.view&&this.view.removeEdge(e),this.trigger("change")},checkLoaded:function(){for(var e=0;this.get("nodes").length>e;e++)if(this.get("nodes").at(e).loaded===!1)return!1;this.loaded=!0;var t=this;return setTimeout(function(){t.connectEdges()},500),!0},reconnectEdges:function(){for(var e=0;this.get("edges").length>e;e++)this.get("edges").at(e).disconnect();setTimeout(function(){Iframework.shownGraph.connectEdges()},500)},connectEdges:function(){this.get("edges").each(function(e){e.connected||e.connect()}),this.get("nodes").each(function(e){e.setState()})},graphChanged:function(){Iframework.trigger("change",this)},toJSON:function(){return{info:this.get("info"),nodes:this.get("nodes"),edges:this.get("edges")}}}),Iframework.Graphs=Backbone.Collection.extend({model:Iframework.Graph})}),$(function(){var e='<div class="edges"><svg id="edgesSvg" class="edgesSvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg></div><div class="nodes" />';Iframework.GraphView=Backbone.View.extend({tagName:"div",className:"graph",template:_.template(e),events:{click:"click",drop:"drop",selectablestart:"selectableStart",selectablestop:"selectableStop",touchstart:"touch",touchmove:"touch",touchend:"touch"},initialize:function(){this.render(),Iframework.$el.prepend(this.el),Iframework.$(".panel").is(":visible")&&this.$el.css("right","350px"),this.model.get("nodes").each(this.addNode),this.$el.droppable({accept:".addnode, .canvas, .meemoo-plugin-images-thumbnail"}).selectable({filter:".module",delay:20}),this.resizeEdgeSVG(),window.requestAnimationFrame(this.renderAnimationFrame)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},renderAnimationFrame:function(e){e=void 0!==e?e:Date.now();var t=Iframework.shownGraph.view;t&&(window.requestAnimationFrame(t.renderAnimationFrame),t.model.get("nodes").each(function(t){t.view.Native&&t.view.Native.renderAnimationFrame(e)}))},touch:function(e){e.stopPropagation()},click:function(){$(".edge-edit").remove(),Iframework.selectedPort=null,this.$(".module").removeClass("active"),this.$(".module").removeClass("ui-selected")},drop:function(e,t){var i=t.helper.data("meemoo-drag-type");if(!i)return!1;var n={x:Math.round(this.$el.scrollLeft()+t.offset.left+10),y:Math.round(this.$el.scrollTop()+t.offset.top+35)};switch(i){case"library-module":var o=t.draggable.data("module");o&&o.view.dragAddNode(n);break;case"canvas":var r=t.helper.data("meemoo-drag-canvas");if(r){n.src="meemoo:image/in",n.canvas=r;var s=t.helper.data("meemoo-image-url");s&&"http"===s.slice(0,4)&&(n.state={},n.state.url=s),Iframework.shownGraph.addNode(n)}break;default:}return!1},addNode:function(e){this.$(".nodes").append(e.initializeView().el),e.lazyLoadType&&e.view.initializeNative()},addEdge:function(e){e.initializeView(),e.Source.view&&e.Source.view.resetRelatedEdges(),e.Target.view&&e.Target.view.resetRelatedEdges()},remove:function(){this.$el.remove()},removeNode:function(e){e.view&&e.view.remove()},removeEdge:function(e){e.Source&&e.Source.view&&e.Source.view.resetRelatedEdges(),e.Target&&e.Target.view&&e.Target.view.resetRelatedEdges(),e.view&&e.view.remove()},resizeEdgeSVG:_.debounce(function(){var e=this.$(".edgesSvg")[0],t=e.getBBox(),i=t.x+t.width,n=t.y+t.height;0===i&&0===n&&(i=this.$el.width(),n=this.$el.height()),e.setAttribute("width",Math.round(i+50)),e.setAttribute("height",Math.round(n+50))},100),selectableStart:function(){this.maskFrames()},selectableStop:function(){this.unmaskFrames()},selectAll:function(){this.$(".module").addClass("ui-selected")},selectNone:function(){this.$(".module").removeClass("ui-selected")},cut:function(){this.copy();var e;for(e=0;Iframework._copied.nodes.length>e;e++)Iframework._copied.nodes[e].x-=50,Iframework._copied.nodes[e].y-=50;var t=this.$(".module.ui-selected");for(e=0;t.length>e;e++)$(t[e]).data("iframework-node-view").removeModel()},copy:function(){var e,t,i={nodes:[],edges:[]},n=this.$(".module.ui-selected");for(e=0;n.length>e;e++){t=$(n[e]).data("iframework-node-view").model;var o=t.toJSON();i.nodes.push(JSON.parse(JSON.stringify(o)))}this.model.get("edges").each(function(o){var r,s=!1;for(e=0;n.length>e;e++)t=$(n[e]).data("iframework-node-view").model,o.Source.node===t&&(r=!0),o.Target.node===t&&(s=!0);r&&s&&i.edges.push(o.toJSON())},this),Iframework._copied=i},paste:function(){var e=Iframework._copied;if(e&&e.nodes.length>0){var t=[];this.$(".module").removeClass("ui-selected");for(var i=0;e.nodes.length>i;i++){var n=e.nodes[i];n.x+=50,n.y+=50;var o=this.model.addNode(n);o.copiedFrom=n.id,t.push(o),o.view&&o.view.select()}for(var r=0;e.edges.length>r;r++){for(var s=e.edges[r],a={source:[],target:[]},l=0;t.length>l;l++){var h=t[l];s.source[0]===h.copiedFrom&&(a.source[0]=h.id),s.target[0]===h.copiedFrom&&(a.target[0]=h.id)}a.source[1]=s.source[1],a.target[1]=s.target[1],a=new Iframework.Edge(a),a.graph=this.model,this.model.addEdge(a)}}},maskFrames:function(){$(".iframe-type").append('<div class="iframemask" />')},unmaskFrames:function(){$(".iframemask").remove()}})}),$(function(){Iframework.Node=Backbone.Model.extend({send:function(){},receive:function(){},sendFromFrame:function(){},iframeLoaded:function(){}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){Iframework.NodeView=Backbone.View.extend({send:function(e){this.model.send(e)},receive:function(e){this.model.receive(e)}})}),$(function(){Iframework.NodeBox=Iframework.Node.extend({loaded:!1,defaults:function(){return{src:"",x:100,y:400,z:0,w:200,h:210,state:{}}},info:{title:"native-node",description:"extend me"},initialize:function(){this.Inputs=new Iframework.PortsIn,this.Outputs=new Iframework.PortsOut,this.parentGraph=this.get("parentGraph"),this.on("change",this.nodeChanged)},initializeView:function(){return this.view=new Iframework.NodeBoxView({model:this}),this.view},send:function(e,t){var i=this;_.defer(function(){i.trigger("send:"+e,t)})},receive:function(e,t){this.view.Native&&this.view.Native.receive(e,t)},infoLoaded:function(e){this.info=e,this.view&&this.view.infoLoaded(e)},setState:function(){var e=this.get("state");if(e&&this.view.Native)for(var t in e)this.view.Native["input"+t]?this.view.Native["input"+t](e[t]):this.view.Native["_"+t]=e[t]},addInput:function(e){e.id=e.name,e.parentNode=this;var t=this.Inputs.get(e.name);if(t)return t.set(e),void 0;var i=new Iframework.PortIn(e);i.isIn=!0,i.node=this,i.graph=this.graph,this.Inputs.add(i),this.view&&this.view.addInput(i);var n=this.get("state");e.hasOwnProperty("default")&&""!==e["default"]&&!n.hasOwnProperty(e.name)&&(n[e.name]=e["default"])},addOutput:function(e){e.id=e.name,e.parentNode=this;var t=this.Outputs.get(e.name);if(t)return t.set(e),void 0;var i=new Iframework.PortOut(e);i.isIn=!1,i.node=this,i.graph=this.graph,this.Outputs.add(i),this.view&&this.view.addOutput(i)},nodeChanged:function(){this.graph&&this.graph.trigger("change")},remove:function(e){e?this.graph.removeNode(this):this.view&&this.view.remove()},setValues:function(e){for(var t in e)this.get("state")[t]=e[t];this.nodeChanged()},setValue:function(e,t){this.get("state")[e]=t,this.nodeChanged()},toString:function(){return this.info?"Native node "+this.get("id")+": "+this.info.title:"Native node "+this.get("id")},toJSON:function(){return{id:this.id,src:this.get("src"),x:this.get("x"),y:this.get("y"),w:this.get("w"),h:this.get("h"),state:this.get("state")}}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){var e='<div class="module" style="left:<%= get("x")-10 %>px;top:<%= get("y")-30 %>px;width:<%= get("w")+20 %>px;height:<%= get("h")+40 %>px;" ><div class="outer"></div><div class="ports ports-in"></div><div class="ports ports-out"></div><h1 class="title">...</h1><button type="button" class="showcontrols">show controls</button><div class="controls"><button type="button" class="remove">remove</button><button type="button" class="hidecontrols">hide controls</button></div><div class="inner"></div></div>';Iframework.NodeBoxView=Iframework.NodeView.extend({tagName:"div",className:"node",template:_.template(e),events:{"dragstart .module":"dragStart","drag .module":"drag","dragstop .module":"dragStop","resizestart .module":"resizestart","resize .module":"resize","resizestop .module":"resizestop","mousedown .module, .title":"mousedown","click .module, .title":"click","click .showcontrols":"showControls","click .hidecontrols":"hideControls","click .remove":"removeModel"},initialize:function(){this.render(),this.$(".module").data({"iframework-node-view":this}).draggable({handle:"h1",helper:function(){var e=$(this);
return $('<div class="ui-draggable-helper" style="width:'+e.width()+"px; height:"+e.height()+'px">')}}).resizable({minHeight:100,minWidth:100,helper:"ui-draggable-helper"}),this.$(".showcontrols").button({icons:{primary:"icon-left-open"},text:!1}),this.$(".hidecontrols").button({icons:{primary:"icon-right-open"},text:!1}),this.$(".remove").button({icons:{primary:"icon-trash"},text:!1}),this.$("h1").disableSelection(),this.mousedown()},initializeNative:function(){this.Native||Iframework.NativeNodes.hasOwnProperty(this.model.lazyLoadType)&&(this.Native=new Iframework.NativeNodes[this.model.lazyLoadType]({model:this.model}),this.$(".inner").append(this.Native.$el),this.model.loaded=!0,this.model.graph.checkLoaded())},render:function(){return this.$el.html(this.template(this.model)),this},infoLoaded:function(e){this.$("h1").text(this.model.get("id")+": "+e.title).attr({title:(e.author?"by "+e.author+": ":"")+e.description})},_alsoDrag:[],_dragDelta:{},dragStart:function(e){if(e.target===this.$(".module")[0]){this.model.graph.view.maskFrames(),this.$(".module").hasClass("ui-selected")||this.click(e);var t=this;this._alsoDrag=[],this.model.parentGraph.view.$(".ui-selected").each(function(){if(t.$(".module")[0]!==this){var e=$(this),i={left:parseInt(e.css("left"),10),top:parseInt(e.css("top"),10)};e.data("ui-draggable-alsodrag-initial",i);var n=$('<div class="ui-draggable-helper">').css({width:e.width(),height:e.height(),left:i.left,top:i.top});e.parent().append(n),e.data("ui-draggable-alsodrag-helper",n),t._alsoDrag.push(e)}})}},drag:function(e){if(e.target===this.$(".module")[0]&&this._alsoDrag.length){var t=$(e.target).data("ui-draggable"),i=t.originalPosition,n={top:t.position.top-i.top||0,left:t.position.left-i.left||0};_.each(this._alsoDrag,function(e){var t=e.data("ui-draggable-alsodrag-initial"),i=e.data("ui-draggable-alsodrag-helper");i.css({left:t.left+n.left,top:t.top+n.top})})}},dragStop:function(e,t){if(e.target===this.$(".module")[0]){var i=parseInt(t.position.left,10),n=parseInt(t.position.top,10);this.moveToPosition(i,n),this._alsoDrag.length&&(_.each(this._alsoDrag,function(e){e.data("ui-draggable-alsodrag-initial");var t=e.data("ui-draggable-alsodrag-helper"),i=e.data("iframework-node-view");i.moveToPosition(parseInt(t.css("left"),10),parseInt(t.css("top"),10)),t.remove(),e.data("ui-draggable-alsodrag-initial",null),e.data("ui-draggable-alsodrag-helper",null)}),this._alsoDrag=[]),this.model.graph.view.unmaskFrames()}},moveToPosition:function(e,t){this.$(".module").css({left:e,top:t}),this.model.set({x:e+10,y:t+30})},resizestart:function(){this.model.graph.view.maskFrames()},resize:function(){},resizestop:function(e,t){this.model.graph.view.unmaskFrames();var i=t.size.width,n=t.size.height;this.model.set({w:i-20,h:n-40}),this.Native&&this.Native.resize(i,n),this.model.graph.view.resizeEdgeSVG()},mousedown:function(e){var t=0;$("div.module").each(function(){var e=Number($(this).css("z-index"));e>t&&(t=e)}),this.$(".module").css("z-index",t+1),e&&e.stopPropagation()},click:function(e){e.ctrlKey||e.metaKey?this.$(".module").toggleClass("ui-selected"):(this.model.parentGraph.view.$(".ui-selected").removeClass("ui-selected"),this.$(".module").addClass("ui-selected")),e.stopPropagation()},select:function(){this.$(".module").addClass("ui-selected")},addInput:function(e){this.$(".ports-in").append(e.initializeView().el)},addOutput:function(e){this.$(".ports-out").append(e.initializeView().el)},showControls:function(){this.$(".showcontrols").hide(),this.$(".controls").show()},hideControls:function(){this.$(".showcontrols").show(),this.$(".controls").hide()},removeModel:function(){this.model.remove(!0)},remove:function(){this.Native&&this.Native.remove(),this.$el.remove()},refresh:function(){},popout:function(){}})}),$(function(){var e='<div class="info" />';Iframework.NodeBoxNativeView=Backbone.View.extend({tagName:"div",className:"nativenode",template:_.template(e),info:{title:"native-node-view",description:"extend me"},inputs:{},outputs:{},initialize:function(){this.render(),this.model.infoLoaded(this.info);for(var e in this.inputs)if(this.inputs.hasOwnProperty(e)){var t=this.inputs[e];t.name=e,this.model.addInput(t)}for(var i in this.outputs)if(this.outputs.hasOwnProperty(i)){var n=this.outputs[i];n.name=i,this.model.addOutput(n)}return this.initializeCategory(),this.initializeModule(),this},initializeCategory:function(){},initializeModule:function(){},render:function(){return this.$el.html(this.template(this.model)),this},redraw:function(){},_triggerRedraw:!1,_lastRedraw:0,renderAnimationFrame:function(e){this._triggerRedraw&&(this._triggerRedraw=!1,this.redraw(e),this._lastRedraw=e)},set:function(e,t){this.model.setValue(e,t)},send:function(e,t){this.model.send(e,t)},receive:function(e,t){this["input"+e]?this["input"+e](t):(this["_"+e]=t,this._triggerRedraw=!0)},toString:function(){return"Native view: "+this.model.get("id")+": "+this.info.title},resize:function(){},connectEdge:function(){},disconnectEdge:function(){},remove:function(){}})}),$(function(){Iframework.NodeBoxIframe=Iframework.NodeBox.extend({initializeView:function(){return this.view=new Iframework.NodeBoxIframeView({model:this}),this.view},info:{title:"iframe-node",description:"extend me"},sendFromFrame:function(e){var t=e.output,i=e.value;"ImageData"===Iframework.util.type(e.value)&&(i=this.makeCanvas(i)),this.send(t,i)},receive:function(e,t){if(this.view&&this.view.iframeloaded){if("HTMLCanvasElement"===Iframework.util.type(t))try{t=t.getContext("2d").getImageData(0,0,t.width,t.height)}catch(i){return!1}var n={};n[e]=t,this.view.iframe.contentWindow.postMessage(n,"*")}else console.error("wat "+this.id+" "+this.frameIndex)},setState:function(){var e=this.get("state");e&&this.receive({setState:e})},iframeLoaded:function(){this.loaded=!0,this.graph.checkLoaded()},toString:function(){return this.info?"Iframe node "+this.get("id")+": "+this.info.title:"Iframe node "+this.get("id")},makeCanvas:function(e){return this.canvas||(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d")),(this.canvas.width!==e.width||this.canvas.height!==e.height)&&(this.canvas.width=e.width,this.canvas.height=e.height),this.context.putImageData(e,0,0),this.canvas}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){Iframework.NodeBoxIframeView=Iframework.NodeBoxView.extend({initialize:function(){Iframework.NodeBoxView.prototype.initialize.call(this),this.$("button.remove").after($('<button type="button" class="refresh">refresh</button>').button({icons:{primary:"icon-cw"},text:!1})),this.events["click .refresh"]="refresh",this.$(".inner").addClass("iframe-type");var e=this;this.iframe.onload=function(){e.iframeloaded=!0}},render:function(){return this.$el.html(this.template(this.model)),this.iframe=document.createElement("iframe"),$(this.iframe).attr({"class":"iframe",name:this.model.frameIndex,src:this.model.get("src")}),this.$(".inner").html(this.iframe),this},refresh:function(){this.$("iframe")[0].src=this.model.get("src")}})}),$(function(){Iframework.Port=Backbone.Model.extend({defaults:{name:"",type:"",description:"","default":null},initialize:function(){""===this.get("type")&&this.set("type","all"),this.set("type_class",this.get("type").split(":")[0]),this.Edges=new Iframework.Edges,this.parentNode=this.get("parentNode")},connect:function(e){this.Edges.add(e)},disconnect:function(e){this.Edges.remove(e)}}),Iframework.Ports=Backbone.Collection.extend({model:Iframework.Port})}),$(function(){var e='<div class="edge-edit"><button class="close">close</button><h2><%= name %> (<%= type %>)</h2><p><%= description %></p></div>',t='<div class="edge-edit-item" id="<%= model.cid %>"><span><%= label() %></span><button class="disconnect" type="button">disconnect</button></div>';Iframework.PortView=Backbone.View.extend({tagName:"div",className:"port",popupTemplate:_.template(e),edgeEditTemplate:_.template(t),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput"},initialize:function(){return this.render(),this},dragstart:function(e,t){this.model.node.graph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var i=new Iframework.EdgeView;Iframework.edgePreview=i,this.drag(e,t),this.$(".plugend").show(),e.stopPropagation()},drag:function(e,t){if(Iframework.edgePreview){var i=t.offset.left+$(".graph").scrollLeft(),n=t.offset.top+8+$(".graph").scrollTop(),o=this.portOffsetLeft(),r=this.portOffsetTop(),s={fromX:this.model.isIn?i-2:o,fromY:this.model.isIn?n:r,toX:this.model.isIn?o:i+20,toY:this.model.isIn?r:n};Iframework.edgePreview.setPositions(s),Iframework.edgePreview.redraw()}e.stopPropagation()},dragstop:function(e){this.model.node.graph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=void 0,1>this.relatedEdges().length&&this.$(".plugend").hide(),e.stopPropagation()},drop:function(e,t){if(this.armDelete)this.armDelete=!1;else{var i=$(t.draggable).data("model"),n=this.model,o=this.model.isIn?i:n,r=this.model.isIn?n:i,s=new Iframework.Edge({source:[o.node.get("id"),o.get("name")],target:[r.node.get("id"),r.get("name")]});s.graph=this.model.graph,Iframework.edgePreview&&(s._color=Iframework.edgePreview._color),s.graph.addEdge(s)&&s.connect()}e.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var e,t=0;return _.each(this.relatedEdges(),function(i){i.view._z>=t&&(t=i.view._z,e=i)},this),e},unplugstart:function(e){this.model.node.graph.view.maskFrames();var t=this.topConnectedEdge();if(!t)return!1;this.unpluggingEdge=t,this.unpluggingEdge.view.dim(),1===this.relatedEdges().length&&this.$(".plugend").hide();var i=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",i),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var n=new Iframework.EdgeView;n.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=n,this.armDelete=!0,e.stopPropagation()},unplugdrag:function(e,t){if(Iframework.edgePreview&&this.unpluggingEdge){var i=t.offset.left+$(".graph").scrollLeft(),n=t.offset.top+6+$(".graph").scrollTop(),o=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,r=o.portOffsetLeft(),s=o.portOffsetTop(),a={fromX:this.model.isIn?r:i-2,fromY:this.model.isIn?s:n,toX:this.model.isIn?i+20:r,toY:this.model.isIn?n:s};Iframework.edgePreview.setPositions(a),Iframework.edgePreview.redraw()}e.stopPropagation()},unplugstop:function(e,t){this.armDelete&&this.unpluggingEdge?this.model.graph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(e,t)},clickhole:function(e){$("div.edge-edit").remove();var t=this.$(".hole"),i=this.model.isIn;if(this.model.get("name"),Iframework.selectedPort&&i!==Iframework.selectedPort.isIn){var n;return n=i?new Iframework.Edge({source:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")],target:[this.model.node.get("id"),this.model.get("name")]}):new Iframework.Edge({source:[this.model.node.get("id"),this.model.get("name")],target:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")]}),n.graph=Iframework.shownGraph,n.graph.addEdge(n)&&n.connect(),Iframework.edgePreview&&(Iframework.shownGraph.view.$(".edges").children(".preview").remove(),Iframework.edgePreview=void 0),Iframework.selectedPort=null,void 0}var o=this.popupTemplate(this.model.toJSON());o=$(o),this.$el.append(o),o.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var r=this.model.get("type").substring(0,3);if(i){var s=!1,a=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput"});if("int"===r||"num"===r||"flo"===r)s=!0,a.append($("<input />").attr({type:"number",min:t.data("min"),max:t.data("max"),step:"any",value:this.model.node.get("state")[this.model.get("name")]}));else if("col"===r||"str"===r)s=!0,a.append($("<input />").attr({type:"text",maxlength:t.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if("boo"===r){s=!0;var l=this.model.node.get("state")[this.model.get("name")];l=Boolean(l)&&"false"!==l,a.append($("<input />").attr({type:"checkbox",checked:l}))}else"ban"===r&&(a.append("<label>Send bang:</label> "),s=!0);s&&(a.append($("<button></button>").html("send").attr({type:"submit","class":"send",title:"send value to module"}).button({icons:{primary:"icon-ok"},text:!1})),o.append(a))}$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(o.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(e){var t=this.edgeEditTemplate(e.view);o.append(t)},this),$(".disconnect").button({icons:{primary:"icon-scissors"},text:!1})),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),e.stopPropagation()},manualinput:function(){var e,t=this.model.get("name");this.$(".manualinput").children("input")&&(e=this.$(".manualinput").children("input").val()),this.$(".manualinput").children("input:checkbox").length>0&&(e=this.$(".manualinput").children("input:checkbox").is(":checked")?!0:!1),"int"===this.model.get("type")&&(e=parseInt(e,10)),("number"===this.model.get("type")||"float"===this.model.get("type"))&&(e=parseFloat(e)),void 0===e&&(e="!");var i={};return i[t]=e,this.model.node.receive(i),this.model.node.get("state")[t]=e,this.model.node.trigger("change"),!1},disconnect:function(e){var t=this.model.graph.get("edges").getByCid($(e.target).parents(".edge-edit-item").attr("id"));t&&this.model.graph.removeEdge(t),$("div.edge-edit").remove(),Iframework.selectedPort=null,e.stopPropagation()},portOffsetLeft:function(){var e=this.$(".hole").offset();return e?e.left+7+$(".graph").scrollLeft():0},portOffsetTop:function(){var e=this.$(".hole").offset();return e?e.top+10+$(".graph").scrollTop():0},_relatedEdges:null,relatedEdges:function(){return null===this._relatedEdges&&(this._relatedEdges=this.model.graph.get("edges").filter(function(e){return e.Source===this.model||e.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide(),this.model.node.view.resetRelatedEdges()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var e=this.topConnectedEdge();e&&e.view&&e.view.highlight()}},highlight:function(){var e=this.$(".plugend");e.addClass("highlight"),setTimeout(function(){e.removeClass("highlight")},1e3)}})}),$(function(){Iframework.PortIn=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortInView({model:this}),this.view}}),Iframework.PortsIn=Backbone.Collection.extend({model:Iframework.PortIn})}),$(function(){var e='<div class="portshown portshown-in"><span class="hole hole-in hole-<%= type_class %> icon-login"></span><span class="label"><%= name %></span></div><span class="plugend plugend-in plugend-<%= type_class %>"></span>';Iframework.PortInView=Iframework.PortView.extend({tagName:"div",className:"port",portInTemplate:_.template(e),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput"},render:function(){this.$el.html(this.portInTemplate(this.model.toJSON())),this.$el.addClass("port-in"),this.$(".hole").draggable({helper:function(){return $('<span class="holehelper holehelper-out" />')}}),this.$(".plugend").draggable({helper:function(){return $('<span class="plugendhelper plugendhelper-in" />')}}),this.$(".hole").data({model:this.model});var e="",t=this.model.get("type_class");e="all"===t||"bang"===t?".hole-out, .plugend-in":".hole-out.hole-all, .hole-out.hole-"+t+", .plugend-in.plugend-all, .plugend-in.plugend-"+t,"string"===t&&(e+=", .hole-out.hole-int, .hole-out.hole-float, .plugend-in.plugend-int, .plugend-in.plugend-float"),("int"===t||"float"===t||"number"===t)&&(e+=", .hole-out.hole-int, .hole-out.hole-float, .hole-out.hole-number, .plugend-in.plugend-int, .plugend-in.plugend-float, .plugend-in.plugend-number"),this.$el.droppable({hoverClass:"drophover",accept:e}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(e,t){this.model.node.graph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var i=new Iframework.EdgeView;Iframework.edgePreview=i,this.drag(e,t),this.$(".plugend").show(),e.stopPropagation()},drag:function(e,t){if(Iframework.edgePreview){var i=t.offset.left+$(".graph").scrollLeft(),n=t.offset.top+8+$(".graph").scrollTop(),o=this.portOffsetLeft(),r=this.portOffsetTop(),s={fromX:this.model.isIn?i-2:o,fromY:this.model.isIn?n:r,toX:this.model.isIn?o:i+20,toY:this.model.isIn?r:n};Iframework.edgePreview.setPositions(s),Iframework.edgePreview.redraw()}e.stopPropagation()},dragstop:function(e){this.model.node.graph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=void 0,1>this.relatedEdges().length&&this.$(".plugend").hide(),e.stopPropagation()},drop:function(e,t){if(this.armDelete)this.armDelete=!1;else{var i=$(t.draggable).data("model"),n=this.model,o=this.model.isIn?i:n,r=this.model.isIn?n:i,s=new Iframework.Edge({source:[o.node.get("id"),o.get("name")],target:[r.node.get("id"),r.get("name")]});s.graph=this.model.graph,Iframework.edgePreview&&(s._color=Iframework.edgePreview._color),s.graph.addEdge(s)&&s.connect()}e.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var e,t=0;return _.each(this.relatedEdges(),function(i){i.view._z>=t&&(t=i.view._z,e=i)},this),e},unplugstart:function(e){this.model.node.graph.view.maskFrames();var t=this.topConnectedEdge();if(!t)return!1;this.unpluggingEdge=t,this.unpluggingEdge.view.dim(),1===this.relatedEdges().length&&this.$(".plugend").hide();var i=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",i),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var n=new Iframework.EdgeView;n.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=n,this.armDelete=!0,e.stopPropagation()},unplugdrag:function(e,t){if(Iframework.edgePreview&&this.unpluggingEdge){var i=t.offset.left+$(".graph").scrollLeft(),n=t.offset.top+6+$(".graph").scrollTop(),o=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,r=o.portOffsetLeft(),s=o.portOffsetTop(),a={fromX:this.model.isIn?r:i-2,fromY:this.model.isIn?s:n,toX:this.model.isIn?i+20:r,toY:this.model.isIn?n:s};Iframework.edgePreview.setPositions(a),Iframework.edgePreview.redraw()}e.stopPropagation()},unplugstop:function(e,t){this.armDelete&&this.unpluggingEdge?this.model.graph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(e,t)},clickhole:function(e){$("div.edge-edit").remove();var t=this.$(".hole"),i=this.model.isIn;if(this.model.get("name"),Iframework.selectedPort&&i!==Iframework.selectedPort.isIn){var n;return n=i?new Iframework.Edge({source:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")],target:[this.model.node.get("id"),this.model.get("name")]}):new Iframework.Edge({source:[this.model.node.get("id"),this.model.get("name")],target:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")]}),n.graph=Iframework.shownGraph,n.graph.addEdge(n)&&n.connect(),Iframework.edgePreview&&(Iframework.shownGraph.view.$(".edges").children(".preview").remove(),Iframework.edgePreview=void 0),Iframework.selectedPort=null,void 0}var o=this.popupTemplate(this.model.toJSON());o=$(o),this.$el.append(o),o.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var r=this.model.get("type").substring(0,3),s=!1,a=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput"});if("int"===r||"num"===r||"flo"===r)s=!0,a.append($("<input />").attr({type:"number",min:t.data("min"),max:t.data("max"),step:"any",value:this.model.node.get("state")[this.model.get("name")]}));else if("col"===r||"str"===r)s=!0,a.append($("<input />").attr({type:"text",maxlength:t.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if("boo"===r){s=!0;var l=this.model.node.get("state")[this.model.get("name")];l=Boolean(l)&&"false"!==l,a.append($("<input />").attr({type:"checkbox",checked:l}))}else"ban"===r&&(a.append("<label>Send bang:</label> "),s=!0);s&&(a.append($("<button></button>").html("send").attr({type:"submit","class":"send",title:"send value to module"}).button({icons:{primary:"icon-ok"},text:!1})),o.append(a)),$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(o.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(e){var t=this.edgeEditTemplate(e.view);o.append(t)},this),$(".disconnect").button({icons:{primary:"icon-scissors"},text:!1})),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),e.stopPropagation()},manualinput:function(){var e,t=this.model.get("name"),i=!0;return this.$(".manualinput").children("input")&&(e=this.$(".manualinput").children("input").val()),this.$(".manualinput").children("input:checkbox").length>0&&(e=this.$(".manualinput").children("input:checkbox").is(":checked")?!0:!1),"int"===this.model.get("type")&&(e=parseInt(e,10)),("number"===this.model.get("type")||"float"===this.model.get("type"))&&(e=parseFloat(e)),void 0===e&&(e="!",i=!1),this.model.node.receive(t,e),i&&this.model.node.setValue(t,e),!1},disconnect:function(e){var t=this.model.graph.get("edges").getByCid($(e.target).parents(".edge-edit-item").attr("id"));t&&this.model.graph.removeEdge(t),$("div.edge-edit").remove(),Iframework.selectedPort=null,e.stopPropagation()},portOffsetLeft:function(){var e=this.$(".hole").offset();return e?e.left+7+$(".graph").scrollLeft():0},portOffsetTop:function(){var e=this.$(".hole").offset();return e?e.top+10+$(".graph").scrollTop():0},_relatedEdges:null,relatedEdges:function(){return null===this._relatedEdges&&(this._relatedEdges=this.model.graph.get("edges").filter(function(e){return e.Source===this.model||e.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var e=this.topConnectedEdge();e&&e.view&&e.view.highlight()}},highlight:function(){var e=this.$(".plugend");e.addClass("highlight"),setTimeout(function(){e.removeClass("highlight")},1e3)}})}),$(function(){Iframework.PortOut=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortOutView({model:this}),this.view}}),Iframework.PortsOut=Backbone.Collection.extend({model:Iframework.PortOut})}),$(function(){var e='<div class="portshown portshown-out"><span class="label"><%= name %></span><span class="hole hole-out hole-<%= type_class %> icon-logout"></span></div><span class="plugend plugend-out plugend-<%= type_class %>"></span>';Iframework.PortOutView=Iframework.PortView.extend({tagName:"div",className:"port",portOutTemplate:_.template(e),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect"},render:function(){this.$el.html(this.portOutTemplate(this.model.toJSON())),this.$el.addClass("port-out"),this.$(".hole").draggable({helper:function(){return $('<span class="holehelper holehelper-in" />')}}),this.$(".plugend").draggable({helper:function(){return $('<span class="plugendhelper plugendhelper-out" />')}}),this.$(".hole").data({model:this.model});var e="",t=this.model.get("type_class");"all"===t?e=".hole-in, .plugend-out":(e=".hole-in.hole-all, .hole-in.hole-"+t+", .plugend-out.plugend-all, .plugend-out.plugend-"+t,e+=", .hole-in.hole-bang, .plugend-out.plugend-string"),("int"===t||"float"===t||"number"===t)&&(e+=", .hole-in.hole-string, .plugend-out.plugend-string",e+=", .hole-in.hole-int, .hole-in.hole-float, .hole-out.hole-number, .plugend-out.plugend-int, .plugend-out.plugend-float, .plugend-out.plugend-number"),this.$el.droppable({hoverClass:"drophover",accept:e}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(e,t){this.model.node.graph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var i=new Iframework.EdgeView;Iframework.edgePreview=i,this.drag(e,t),this.$(".plugend").show(),e.stopPropagation()},drag:function(e,t){if(Iframework.edgePreview){var i=t.offset.left+$(".graph").scrollLeft(),n=t.offset.top+8+$(".graph").scrollTop(),o=this.portOffsetLeft(),r=this.portOffsetTop(),s={fromX:this.model.isIn?i-2:o,fromY:this.model.isIn?n:r,toX:this.model.isIn?o:i+20,toY:this.model.isIn?r:n};Iframework.edgePreview.setPositions(s),Iframework.edgePreview.redraw()}e.stopPropagation()},dragstop:function(e){this.model.node.graph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=void 0,1>this.relatedEdges().length&&this.$(".plugend").hide(),e.stopPropagation()},drop:function(e,t){if(this.armDelete)this.armDelete=!1;else{var i=$(t.draggable).data("model"),n=this.model,o=this.model.isIn?i:n,r=this.model.isIn?n:i,s=new Iframework.Edge({source:[o.node.get("id"),o.get("name")],target:[r.node.get("id"),r.get("name")]});s.graph=this.model.graph,Iframework.edgePreview&&(s._color=Iframework.edgePreview._color),s.graph.addEdge(s)&&s.connect()}e.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var e,t=0;return _.each(this.relatedEdges(),function(i){i.view._z>=t&&(t=i.view._z,e=i)},this),e},unplugstart:function(e){this.model.node.graph.view.maskFrames();var t=this.topConnectedEdge();if(!t)return!1;this.unpluggingEdge=t,this.unpluggingEdge.view.dim(),1===this.relatedEdges().length&&this.$(".plugend").hide();var i=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",i),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var n=new Iframework.EdgeView;n.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=n,this.armDelete=!0,e.stopPropagation()},unplugdrag:function(e,t){if(Iframework.edgePreview&&this.unpluggingEdge){var i=t.offset.left+$(".graph").scrollLeft(),n=t.offset.top+6+$(".graph").scrollTop(),o=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,r=o.portOffsetLeft(),s=o.portOffsetTop(),a={fromX:this.model.isIn?r:i-2,fromY:this.model.isIn?s:n,toX:this.model.isIn?i+20:r,toY:this.model.isIn?n:s};Iframework.edgePreview.setPositions(a),Iframework.edgePreview.redraw()}e.stopPropagation()},unplugstop:function(e,t){this.armDelete&&this.unpluggingEdge?this.model.graph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(e,t)},clickhole:function(e){$("div.edge-edit").remove(),this.$(".hole"),this.model.isIn,this.model.get("name");var t=this.popupTemplate(this.model.toJSON());t=$(t),this.$el.append(t),t.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null}),this.model.get("type").substring(0,3),$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(t.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(e){var i=this.edgeEditTemplate(e.view);t.append(i)},this),$(".disconnect").button({icons:{primary:"icon-scissors"},text:!1})),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),e.stopPropagation()},disconnect:function(e){var t=this.model.graph.get("edges").getByCid($(e.target).parents(".edge-edit-item").attr("id"));t&&this.model.graph.removeEdge(t),$("div.edge-edit").remove(),Iframework.selectedPort=null,e.stopPropagation()},portOffsetLeft:function(){var e=this.$(".hole").offset();return e?e.left+7+$(".graph").scrollLeft():0},portOffsetTop:function(){var e=this.$(".hole").offset();return e?e.top+10+$(".graph").scrollTop():0},_relatedEdges:null,relatedEdges:function(){return null===this._relatedEdges&&(this._relatedEdges=this.model.graph.get("edges").filter(function(e){return e.Source===this.model||e.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var e=this.topConnectedEdge();e&&e.view&&e.view.highlight()}},highlight:function(){var e=this.$(".plugend");e.addClass("highlight"),setTimeout(function(){e.removeClass("highlight")},1e3)}})}),$(function(){Iframework.Module=Backbone.Model.extend({defaults:{src:"",info:{}},initialize:function(){},initializeView:function(){return this.view||(this.view=new Iframework.ModuleView({model:this})),this.view},toJSON:function(){return{src:this.get("src"),info:this.get("info")}}}),Iframework.Modules=Backbone.Collection.extend({model:Iframework.Module,findOrAdd:function(e){var t;return t=this.find(function(t){return t.get("src")===e.get("src")}),t||(t=new Iframework.Module({node:e}),this.add(t)),t}})}),$(function(){var e='<div class="addnode button icon-window" title="drag to graph"></div><h2 class="title"><%= info.title %></h2><p class="description"><%= info.description %></p><p class="src"><%= src %></p>';Iframework.ModuleView=Backbone.View.extend({tagName:"div",className:"library-module",template:_.template(e),events:{"click .addnode":"addNode","dragstart .addnode":"dragStart","dragstop .addnode":"dragStop"},initialize:function(){return this.render(),this.$(".addnode").data({module:this.model}).draggable({helper:function(){var e=$('<div class="addnode-drag-helper" />').data({"meemoo-drag-type":"library-module"}).text($(this).data("module").get("info").title);return $(".app").append(e),e}}),this},render:function(){this.$el.html(this.template(this.model.toJSON()))},addNode:function(e){Iframework.$(".addbyurlinput").val(this.model.get("src")),Iframework.addByUrl(e)},dragAddNode:function(e){e.src=this.model.get("src"),Iframework.shownGraph.addNode(e)
},dragStart:function(){Iframework.shownGraph.view.maskFrames()},dragStop:function(){Iframework.shownGraph.view.unmaskFrames()}})}),$(function(){Iframework.Edge=Backbone.Model.extend({defaults:{source:[0,"default"],target:[0,"default"]},initialize:function(){},initializeView:function(){return this.view=new Iframework.EdgeView({model:this}),this.view},Source:null,Target:null,connectTryCount:5,connected:!1,connect:function(){try{this.Source=this.graph.get("nodes").get(this.get("source")[0]).Outputs.get(this.get("source")[1]),this.Target=this.graph.get("nodes").get(this.get("target")[0]).Inputs.get(this.get("target")[1])}catch(e){if(console.warn("Edge source or target port not found, try #"+this.connectTryCount+": "+(""+this)),this.connectTryCount>0){this.connectTryCount--;var t=this;_.delay(function(){t.connect()},1e3)}return!1}return this.Source&&this.Target?(this.Source.connect(this),this.Target.connect(this),this.Source.node.receive({connect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.graph.view&&this.graph.view.addEdge(this),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.connectEdge(this),this.connected=!0,this.Source.node.on("send:"+this.Source.id,this.send,this),this):!1},send:function(e){this.Target.node.receive(this.Target.id,e)},disconnect:function(){this.Source&&this.Target&&(this.Source.disconnect(this),this.Target.disconnect(this),this.Source.node.receive({disconnect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.disconnectEdge(this)),this.view&&this.view.remove(),this.Source.node.off("send:"+this.Source.id,this.send,this),this.connected=!1},remove:function(){this.graph.removeEdge(this)},toString:function(){return this.get("source")[0]+":"+this.get("source")[1]+"->"+this.get("target")[0]+":"+this.get("target")[1]}}),Iframework.Edges=Backbone.Collection.extend({model:Iframework.Edge})}),$(function(){Iframework.EdgeView=Backbone.View.extend({tagName:"div",className:"edge",positions:null,graphSVGElement:null,elementGroup:null,elementWire:null,elementShadow:null,isPreview:!1,initialize:function(){this.graphSVGElement=document.getElementById("edgesSvg"),this.positions={fromX:0,fromY:0,toX:0,toY:0},this.model||(this.isPreview=!0),this.model&&this.model._color&&(this._color=this.model._color),this.render(),this.model&&(this._z=this.model.graph.edgeCount++,$(this.elementWire).data({model:this.model}).click(function(e){$(e.target).data("model").view.click(e)}),this.model.Source&&this.model.Source.parentNode.on("change:x change:y change:w change:h",this.redraw,this),this.model.Target&&this.model.Target.parentNode.on("change:x change:y",this.redraw,this))},render:function(){return this.calcPositions(),this.elementGroup=this.makeSVG("g",{transform:"translate("+this.svgX()+","+this.svgY()+")","class":"wire-group"+(this.isPreview?" preview":"")}),this.elementShadow=this.makeSVG("path",{"class":"wire-shadow",d:this.svgPathShadow()}),this.elementWire=this.makeSVG("path",{"class":"wire",d:this.svgPath(),stroke:this.color()}),this.elementGroup.appendChild(this.elementShadow),this.elementGroup.appendChild(this.elementWire),this.graphSVGElement.appendChild(this.elementGroup),this.model&&(this.model.Source.view.$(".plugend").show(),this.model.Target.view.$(".plugend").show(),this.model.graph.view.resizeEdgeSVG()),this},redraw:function(){this.calcPositions(),$(this.elementGroup).attr("transform","translate("+this.svgX()+", "+this.svgY()+")"),$(this.elementWire).attr("d",this.svgPath()),$(this.elementShadow).attr("d",this.svgPathShadow()),this.model?this.model.graph.view.resizeEdgeSVG():Iframework.shownGraph.view.resizeEdgeSVG()},remove:function(){$(this.elementGroup).remove()},setPositions:function(e){this.positions=e},calcPositions:function(){if(this.model){var e=this.model.get("source")[1],t=this.model.get("target")[1];this.positions.fromX=this.model.Source.view.portOffsetLeft("out",e),this.positions.fromY=this.model.Source.view.portOffsetTop("out",e),this.positions.toX=this.model.Target.view.portOffsetLeft("in",t),this.positions.toY=this.model.Target.view.portOffsetTop("in",t)}},svgX:function(){return Math.min(this.positions.toX,this.positions.fromX)-50},svgY:function(){return Math.min(this.positions.toY,this.positions.fromY)-25},svgW:function(){return Math.abs(this.positions.toX-this.positions.fromX)+100},svgH:function(){return Math.abs(this.positions.toY-this.positions.fromY)+50},pathStraight:35,pathCurve:60,svgPath:function(){var e=this.positions.fromX-this.svgX(),t=this.positions.fromY-this.svgY(),i=this.positions.toX-this.svgX(),n=this.positions.toY-this.svgY();return"M "+e+" "+t+" L "+(e+this.pathStraight)+" "+t+" C "+(e+this.pathCurve)+" "+t+" "+(i-this.pathCurve)+" "+n+" "+(i-this.pathStraight)+" "+n+" L "+i+" "+n},svgPathShadow:function(){var e=this.positions.fromX-this.svgX(),t=this.positions.fromY-this.svgY()+1,i=this.positions.toX-this.svgX(),n=this.positions.toY-this.svgY()+1;return"M "+e+" "+t+" L "+(e+this.pathStraight)+" "+t+" C "+(e+this.pathCurve)+" "+t+" "+(i-this.pathCurve)+" "+n+" "+(i-this.pathStraight)+" "+n+" L "+i+" "+n},color:function(){return this._color?this._color:this.model?(this._color=Iframework.getWireColor(),this._color):Iframework.wireColors[Iframework.wireColorIndex]},setColor:function(e){this._color=e,$(this.elementWire).attr("stroke",e)},label:function(){return this.model.get("source")[0]+":"+this.model.get("source")[1]+'<span class="wiresymbol" style="color:'+this._color+'">&rarr;</span>'+this.model.get("target")[0]+":"+this.model.get("target")[1]},makeSVG:function(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg",e);for(var n in t)"xlink:href"===n?i.setAttributeNS("http://www.w3.org/1999/xlink","href",t[n]):i.setAttribute(n,t[n]);return i},dim:function(){$(this.elementGroup).attr("opacity",.2)},undim:function(){$(this.elementGroup).attr("opacity",1)},click:function(){this._z<this.model.graph.edgeCount-1&&(this.graphSVGElement.appendChild(this.elementGroup),this._z=this.model.graph.edgeCount++),this.highlight()},highlight:function(){var e=$(this.elementShadow);e.attr("class","wire-shadow highlight"),setTimeout(function(){e.attr("class","wire-shadow")},1e3),this.model.Source.view&&this.model.Source.view.highlight(),this.model.Target.view&&this.model.Target.view.highlight()}})}),$(function(){var e=Backbone.Router.extend({routes:{"example/:url":"loadExample","new":"newBlank","local/:url":"loadLocal","gist/https://gist.github.com/:user/:id":"loadGistUgly","gist/:id":"loadGist","*path":"default"},loadExample:function(e){Iframework.loadExample(e)},loadGistUgly:function(e){this.navigate("gist/"+e,{replace:!0}),this.loadGist(e)},loadLocal:function(e){Iframework.loadLocal(e)},loadGist:function(e){Iframework.loadFromGistId(e)},newBlank:function(){Iframework.newBlank()},"default":function(){}});Iframework.router=new e,Backbone.history.start()}),$(function(){var e='<div class="info" />';Iframework.NativeNodes.image=Iframework.NodeBoxNativeView.extend({template:_.template(e),canvas:null,context:null,initializeCategory:function(){var e=this;this.model.view.$("button.remove").after($('<button type="button" class="popout">popout</button>').button({icons:{primary:"icon-popup"},text:!1}).click(function(){e.popout()})),this.canvas=document.createElement("canvas"),this.canvas.width=10,this.canvas.height=10,this.context=this.canvas.getContext("2d"),$(this.canvas).attr({"class":"canvas",id:"canvas-"+this.model.id}).css({maxWidth:"100%",cursor:"pointer"}).draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(){var t=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-node":e});return $(document.body).append(t),_.delay(function(){e.dragCopyCanvas(t)},100),t}});var t;for(var i in this.inputs)if("image"===this.inputs[i].type){t=i;break}t&&(this.$el.append('<div class="drop-indicator"><p class="icon-login">input '+t+"</p></div>"),this.$el.droppable({accept:".canvas, .meemoo-plugin-images-thumbnail",tolerance:"pointer",hoverClass:"drop-hover",activeClass:"drop-active",greedy:!0}),this.$el.on("drop",{self:this,inputName:t},Iframework.util.imageDrop)),this.$el.prepend(this.canvas)},dragCopyCanvas:function(e){if(e){var t=document.createElement("canvas");t.width=this.canvas.width,t.height=this.canvas.height,t.getContext("2d").drawImage(this.canvas,0,0),e.data("meemoo-drag-canvas",t),e.append(t)}},scale:function(){return this.$(".canvas").width()/this.canvas.width},outputs:{image:{type:"image"}},_smoothing:!0,inputsmoothing:function(e){this._smoothing=e,this.context.webkitImageSmoothingEnabled=e,this.context.mozImageSmoothingEnabled=e},exportImage:function(){try{var e=this.canvas.toDataURL();window.open(e)}catch(t){}},popout:function(){if(this.w)return this.popin(),!1;this.localCanvas=this.canvas,this.localContext=this.context,this.w=window.open("","meemooRemoteWindow","menubar=no,location=no,resizable=yes,scrollbars=no,status=no");var e=this;return this.w.addEventListener("unload",function(){e.popin()}),Iframework.popoutModule&&Iframework.popoutModule!==this&&Iframework.popoutModule.popin(),Iframework.popoutModule=this,this.w.document.body.innerHTML="",this.canvas=this.w.document.createElement("canvas"),this.canvas.width=this.localCanvas.width,this.canvas.height=this.localCanvas.height,this.context=this.canvas.getContext("2d"),this.w.document.body.appendChild(this.canvas),this.w.document.body.style.backgroundColor="black",this.w.document.body.style.overflow="hidden",this.w.document.body.style.margin="0px",this.w.document.body.style.padding="0px",this.w.document.title="meemoo.org",this.canvas.style.position="absolute",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.width="100%",this.inputsmoothing(this._smoothing),!1},popin:function(){return this.w&&(this.w=null),this.canvas=this.localCanvas,this.context=this.localContext,this.inputsmoothing(this._smoothing),!1}})}),function(e){var t=$('<div><div class="sourceedit"><textarea /></div><div class="controls"><button class="button sourcerefresh icon-cw" title="refresh the source code">refresh</button><button class="button sourcecompress icon-bag" title="refresh and compress the source code into one line">compress</button><button class="button sourceapply icon-ok" title="reloads the app">apply changes</button></div></div>'),i=t.find("textarea");e.addMenu("source",t,"icon-cog"),e.on("change",function(){if(e.shownGraph&&e.$(".menu-source").is(":visible")){var t=i.prop("scrollTop");i.val(JSON.stringify(e.shownGraph.toJSON(),null,"  ")),i.scrollTop(t)}});var n=function(){i.val(JSON.stringify(e.shownGraph,null,"  "))};t.find(".sourcerefresh").click(n),e.on("showmenu:source",n);var o=function(){i.val(JSON.stringify(e.shownGraph,null,""))};t.find(".sourcecompress").click(o);var r=function(){var t;try{t=JSON.parse(i.val())}catch(o){return!1}if(t){var r=e.loadGraph(t);e._loadedLocalApp=null,n(),r.trigger("change")}return!1};t.find(".sourceapply").click(r)}(Iframework),function(e){var t=$('<div><div class="controls"><form class="addbyurl"><input class="addbyurlinput" name="addbyurlinput" placeholder="search or url" type="text" /><button class="addbyurlsubmit icon-ok" type="submit">load</button></form></div><div class="listing"></div></div>');e.addMenu("library",t,"icon-plus"),e.loadLibrary=function(i){var n=[],o=$("<div></div>");for(var r in i)if(i.hasOwnProperty(r)){var s=$('<div class="library-section"></div>');s.append($('<h3><a href="#">'+r+"</a></h3>"));for(var a=$("<div></div>"),l=i[r],h=0;l.length>h;h++){var d=new e.Module(l[h]);d.initializeView(),a.append(d.view.$el);var u={value:d.get("src"),label:d.get("info").title+" - "+d.get("info").description+" - "+d.get("src"),title:d.get("info").title,description:d.get("info").description+" - "+d.get("src")};n.push(u)}s.append(a),o.append(s)}t.find(".listing").append(o),o.children(".library-section").accordion({animate:!1,header:"h3",heightStyle:"content",collapsible:!0,active:!1}),t.find(".addbyurlinput").autocomplete({minLength:1,source:n,select:function(){_.defer(function(){e.addByUrl()})}}).data("ui-autocomplete")._renderItem=function(e,t){return $("<li>").append('<a><span style="font-size:120%;">'+t.title+"</span><br>"+t.description+"</a>").appendTo(e)}};var i=e.addByUrl=function(){var t=e.$(".addbyurlinput");t.blur();var i=t.val();if(""!==i){var n=e.$(".graph");e.shownGraph.addNode({src:i,x:Math.floor(n.scrollLeft()+n.width()/2)-100,y:Math.floor(n.scrollTop()+n.height()/2)-100}),t.val("").attr("placeholder","loading..."),window.setTimeout(function(){t.attr("placeholder","search or url")},1e3)}return!1};t.find(".addbyurl").submit(function(){return i(),!1})}(Iframework),function(e){var t="AaqPpE9LORQel03S9cCl7z",i="http://i.meemoo.me/";window.URL||(window.URL=window.webkitURL||window.msURL||window.oURL||!1);var n=$('<div class="meemoo-plugin-images"><div class="listing"><h2>Local images (not saved)</h2><span style="position:absolute;width:0px;overflow:hidden;"><input type="file" class="file-input-local" accept="image/*" multiple /></span><button class="localfile icon-camera" title="Not public. From computer (or mobile camera).">Choose local image</button> from computer or mobile camera<div class="image-drop local-drop"><div class="drop-indicator"><p>drag image here to hold it</p></div></div><div class="thumbnails local-listing"></div><h2>Meemoo.me images (public)</h2><span style="position:absolute;width:0px;overflow:hidden;"><input type="file" class="file-input-public" accept="image/*" /></span><button disabled class="publicfile icon-camera" title="Import from computer (or mobile camera).">Upload</button><button disabled class="publicfile-service icon-globe-1" title="Upload image to Meemoo from computer, URL, Flickr, Google, Dropbox...">Import from Flickr, Dropbox, etc.</button><div class="info"></div><div class="image-drop public-drop"><div class="drop-indicator"><p class="icon-globe-1">drag image here to save to meemoo.me</p></div></div><div class="thumbnails public-listing"></div></div></div>');e.addMenu("images",n,"icon-picture");var o=n.find(".info"),r=function(e){o.text(e)};yepnope({load:"http://api.filepicker.io/v1/filepicker.js",complete:function(){window.filepicker?(filepicker.setKey(t),n.find(".publicfile, .publicfile-service").prop("disabled",!1)):r("Offline or image service not available.")}}),e.$(".show-images").droppable({accept:".canvas",tolerance:"pointer",activeClass:"drop-indicator",over:function(){$(this).trigger("click")}}),n.find(".image-drop").droppable({accept:".canvas",hoverClass:"drop-hover",activeClass:"drop-active",greedy:!0}),n.find(".local-drop").on("drop",function(e,t){var i=t.helper.data("meemoo-drag-canvas");if(!i)return!1;var n=s(i);h.append(n)});var s=function(e){var t=$('<div class="meemoo-plugin-images-thumbnail canvas">').append(e).draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(){var t=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-image":e});return $(document.body).append(t),_.delay(function(){a(t)},100),t}});return t},a=function(e){if(e){var t=e.data("meemoo-source-image"),i=document.createElement("canvas");i.width=t.naturalWidth?t.naturalWidth:t.width,i.height=t.naturalHeight?t.naturalHeight:t.height,i.getContext("2d").drawImage(t,0,0),e.data("meemoo-drag-canvas",i),e.append(i)}},l=n.find(".file-input-local"),h=n.find(".local-listing");l.change(function(e){for(var t=e.target.files,i=0;t.length>i;i++){var n=new Image;n.src=window.URL.createObjectURL(t[i]);var o=s(n);h.append(o)}}),n.find(".localfile").click(function(){l.trigger("click")});var d=function(t){for(var i=0;t.length>i;i++){var n={main:t[i]},o=new e.plugins.images.GalleryImage({files:n});g.add(o),o.save()}},u=n.find(".public-listing");n.find(".publicfile-service").click(function(){return window.filepicker?(filepicker.pickAndStore({mimetype:"image/*",multiple:!0,maxSize:5242880},{location:"S3",path:"v1/in/",access:"public"},d),void 0):(r("Image service not yet available."),!1)});var c=n.find(".file-input-public");c.change(function(e){return window.filepicker?(e.target.files.length>0&&(r("Uploading..."),filepicker.store(e.target,{location:"S3",path:"v1/in/",access:"public"},function(e){var t=[];t.push(e),d(t)},function(){r("Upload error :-(")},function(e){r(e+"% uploaded.")})),void 0):(r("Image service not yet available."),!1)}),n.find(".publicfile").click(function(){return window.filepicker?(c.trigger("click"),void 0):(r("Image service not yet available."),!1)}),n.find(".public-drop").on("drop",function(t,i){if(!window.filepicker)return r("Image service not yet available."),!1;var n=i.helper.data("meemoo-drag-canvas");if(!n)return!1;var o;try{o=n.toDataURL().split(",",2)[1]}catch(s){return r('Not able to get image data. Right-click "Save as..." or take a screenshot.'),!1}r("Uploading..."),filepicker.store(o,{mimetype:"image/png",location:"S3",path:"v1/out/",filename:"meemoo.png",access:"public",base64decode:!0},function(t){var i={main:t},n=new e.plugins.images.GalleryImage({files:i});g.add(n),n.save(),r("Upload done :-)"),_.delay(function(){r("")},2e3)},function(){r("Upload error :-(")},function(e){r(e+"% uploaded.")})}),e.plugins.images={},e.plugins.images.GalleryImage=Backbone.Model.extend({initialize:function(){this.mainsrc=i+this.get("files").main.key;var e=this.get("files").thumb;if(e&&e.key)this.thumbsrc=i+e.key;else{this.thumbsrc=this.mainsrc;var t=this;_.delay(function(){t.makeThumb()},3e3)}this.initializeView()},initializeView:function(){return this.view||(this.view=new e.plugins.images.GalleryImageView({model:this})),this.view},makeThumb:function(){var e=this,t=this.get("files").main;t&&window.filepicker&&filepicker.convert(t,{fit:"crop",width:100,height:100},{location:"S3",path:"v1/thumbs/",access:"public"},function(t){var i=e.get("files");i.thumb=t,e.save()},function(){})},toJSON:function(){return{id:this.id,files:this.get("files")}}}),e.plugins.images.GalleryImages=Backbone.Collection.extend({model:e.plugins.images.GalleryImage,localStorage:new Backbone.LocalStorage("GalleryImages")});var p='<img crossorigin="anonymous" title="drag to graph or image node" /><div class="controls"><a class="link button icon-link" title="Open image in new window" target="_blank"></a><button class="export-public icon-export" title="Save straight to Flickr, Dropbox, Google, Facebook..."></button><button class="delete icon-trash" title="Delete image"></button></div>';e.plugins.images.GalleryImageView=Backbone.View.extend({tagName:"div",className:"meemoo-plugin-images-thumbnail",template:_.template(p),events:{"click .export-public":"exportPublic","click .delete":"destroyModel"},initialize:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.mainsrc;this.$(".link").attr("href",e);var t=this.$("img")[0];return t.src=this.model.thumbsrc,this.$el.draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(){var i=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-image":t,"meemoo-image-url":e});return $(document.body).append(i),_.delay(function(){a(i)},100),i}}),u.prepend(this.el),this.model.on("destroy",this.remove,this),this},exportPublic:function(){if(!window.filepicker)return r("Image service not available."),!1;var e=this.model.get("files").main.url;filepicker.exportFile(e,{mimetype:"image/png"},function(){})},destroyModel:function(){if(window.confirm("Are you sure you want to delete this image?")){if(window.filepicker){var e=this.model.get("files").main;filepicker.remove(e,function(){})}this.model.destroy()}},remove:function(){this.$el.remove()}});var g=new e.plugins.images.GalleryImages;g.fetch({success:function(){g.each(function(e){e.initializeView()})},error:function(){console.warn("error loading public images")}})}(Iframework),$(function(){Iframework.allLoaded(),Mousetrap.bind(["command+a","ctrl+a"],function(e){Iframework.shownGraph&&Iframework.shownGraph.view&&(e.preventDefault(),Iframework.shownGraph.view.selectAll())}),Mousetrap.bind(["command+x","ctrl+x"],function(){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework.shownGraph.view.cut()}),Mousetrap.bind(["command+c","ctrl+c"],function(){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework.shownGraph.view.copy()}),Mousetrap.bind(["command+v","ctrl+v"],function(){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework.shownGraph.view.paste()})});